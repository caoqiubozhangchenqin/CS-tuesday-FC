# 🎯 快速添加《我 中国队长》到书架

## 📚 书籍信息
- **书名**：我 中国队长
- **文件ID**：`cloud://cloud1-3ge5gomsffe800a7.636c-cloud1-3ge5gomsffe800a7-1373366709/小说/我 中国队长.txt`
- **大小**：> 10 MB
- **格式**：TXT

---

## 🚀 最快方法（30秒完成）

### 步骤1：双击运行部署脚本
```powershell
# Windows
双击运行：deploy-addBook.bat
# 或
双击运行：deploy-addBook.ps1
```

### 步骤2：部署云函数
1. 打开**微信开发者工具**
2. 找到 `cloudfunctions/addBookToShelf` 文件夹
3. **右键点击** → 选择 **"上传并部署：云端安装依赖"**
4. 等待约30秒

### 步骤3：在控制台执行代码
在微信开发者工具的**控制台**（Console）中输入：

```javascript
wx.cloud.callFunction({
  name: 'addBookToShelf',
  data: {
    name: '我 中国队长',
    author: '未知作者',
    intro: '一本超过10MB的大型小说，讲述中国队长的故事。',
    category: '未分类',
    format: 'TXT',
    fileID: 'cloud://cloud1-3ge5gomsffe800a7.636c-cloud1-3ge5gomsffe800a7-1373366709/小说/我 中国队长.txt',
    cloudPath: '小说/我 中国队长.txt',
    size: 10485760,
    sizeText: '> 10 MB'
  }
}).then(res => {
  console.log('✅ 添加成功:', res);
  wx.showToast({ title: '已添加到书架', icon: 'success' });
});
```

### 步骤4：验证
1. 进入小程序的**书架**页面
2. 应该能看到《我 中国队长》
3. 点击即可开始阅读（首次需要解析，约30-60秒）

---

## 📝 备选方法

### 方法A：使用测试页面（图形界面）

1. 在 `miniprogram/app.json` 的 `pages` 数组中添加：
```json
"pages/test/addBook"
```

2. 在控制台执行：
```javascript
wx.navigateTo({ url: '/pages/test/addBook' })
```

3. 点击"添加到书架"按钮

### 方法B：直接在云开发控制台添加

1. 打开云开发控制台 → 数据库 → `novels` 集合
2. 点击"添加记录"
3. 粘贴以下JSON：

```json
{
  "name": "我 中国队长",
  "author": "未知作者",
  "intro": "一本超过10MB的大型小说，讲述中国队长的故事。",
  "category": "未分类",
  "format": "TXT",
  "fileID": "cloud://cloud1-3ge5gomsffe800a7.636c-cloud1-3ge5gomsffe800a7-1373366709/小说/我 中国队长.txt",
  "cloudPath": "小说/我 中国队长.txt",
  "size": 10485760,
  "sizeText": "> 10 MB",
  "uploadTime": 1700650000000
}
```

---

## ⚠️ 注意事项

### 1. 首次打开需要解析（30-60秒）
- 超过10MB的书籍解析需要时间
- 解析后章节会保存到数据库
- 第二次打开就很快了

### 2. 如果解析超时
修改 `miniprogram/pages/novel/shelf/shelf.js` 第125行：
```javascript
config: {
  timeout: 120000  // 改为120秒（原来是60秒）
}
```

### 3. 数据库权限检查
确保以下集合权限正确：

**novels 集合**：
```json
{
  "read": true,
  "write": "doc._openid == auth.openid"
}
```

**novel_chapters 集合**：
```json
{
  "read": true,
  "write": "doc._openid == auth.openid"
}
```

---

## 📂 已创建的文件

### 云函数
- ✅ `cloudfunctions/addBookToShelf/index.js` - 添加书籍云函数
- ✅ `cloudfunctions/addBookToShelf/package.json` - 依赖配置
- ✅ `cloudfunctions/addBookToShelf/config.json` - 云函数配置

### 测试页面
- ✅ `miniprogram/pages/test/addBook.wxml` - 页面结构
- ✅ `miniprogram/pages/test/addBook.js` - 页面逻辑
- ✅ `miniprogram/pages/test/addBook.wxss` - 页面样式
- ✅ `miniprogram/pages/test/addBook.json` - 页面配置

### 脚本和文档
- ✅ `deploy-addBook.bat` - Windows批处理脚本
- ✅ `deploy-addBook.ps1` - PowerShell脚本
- ✅ `添加书籍到书架指南.md` - 详细操作指南
- ✅ `add-book-to-shelf.js` - 备用脚本

---

## 🎯 流程图

```
1. 运行部署脚本
        ↓
2. 部署云函数到云端
        ↓
3. 在控制台执行代码
        ↓
4. 云函数添加记录到 novels 集合
        ↓
5. 书架页面显示《我 中国队长》
        ↓
6. 点击书籍 → 解析章节（首次）
        ↓
7. 章节保存到 novel_chapters 集合
        ↓
8. 打开阅读器，开始阅读
```

---

## ✅ 完成检查清单

- [ ] 运行了部署脚本（deploy-addBook.bat 或 .ps1）
- [ ] 云函数 addBookToShelf 已部署到云端
- [ ] 在控制台执行了添加代码
- [ ] 控制台显示"✅ 添加成功"
- [ ] 书架页面能看到《我 中国队长》
- [ ] 点击书籍可以正常打开

---

## 💡 遇到问题？

### Q: 控制台报错"云函数不存在"
**A**: 确保已经部署云函数到云端（右键 → 上传并部署）

### Q: 书架页面看不到书籍
**A**: 刷新书架页面，或检查数据库中是否有记录

### Q: 点击书籍后一直加载
**A**: 解析大文件需要时间，请耐心等待30-60秒

### Q: 显示"解析失败"
**A**: 检查 fileID 是否正确，文件是否存在于云存储中

---

## 📞 需要帮助？

查看详细文档：
- 📄 **添加书籍到书架指南.md** - 完整操作说明
- 📄 **云小说共享配置指南.md** - 数据库权限配置
- 📄 **章节目录优化说明-滑动模式.md** - 阅读器使用说明

---

**创建时间**：2025年11月22日  
**状态**：✅ 就绪，可以开始添加  
**预计耗时**：2-3分钟
