# 云函数部署指南

## 🚨 当前问题

您遇到的错误：
```
Error: errCode: -501000 | errMsg: FunctionName parameter could not be found.
```

**原因**：`parseNovel` 云函数还没有部署到云端。

---

## 📦 需要部署的云函数

### 1. parseNovel（必需）
**作用**：解析上传的 TXT/EPUB 小说文件，提取章节内容

**部署步骤**：
1. 在微信开发者工具中，找到 `cloudfunctions/parseNovel` 文件夹
2. 右键点击 `parseNovel` 文件夹
3. 选择 **"上传并部署：云端安装依赖"**
4. 等待部署完成（约30秒-1分钟）

**依赖包**：
- `iconv-lite`: 处理 GBK 编码
- `adm-zip`: 解析 EPUB 文件
- `xml2js`: 解析 EPUB 的 OPF 元数据

---

### 2. checkNovelAdmin（可选）
**作用**：服务端验证管理员权限

**部署步骤**：同 parseNovel

---

## 🎯 快速部署流程

### 方法一：通过开发者工具（推荐）

```
1. 打开微信开发者工具
2. 展开 cloudfunctions 目录
3. 找到 parseNovel 文件夹
4. 右键 → "上传并部署：云端安装依赖"
5. 等待完成
```

### 方法二：批量部署

1. 右键点击 `cloudfunctions` 根目录
2. 选择 **"同步云函数列表"**
3. 在弹出的列表中勾选：
   - ✅ parseNovel
   - ✅ checkNovelAdmin（可选）
4. 点击确定

---

## ✅ 验证部署是否成功

### 1. 在开发者工具中验证
- 点击工具栏的 `云开发` 图标
- 进入 `云函数` 页面
- 查看列表中是否有 `parseNovel`
- 状态应该显示为 **"已部署"**

### 2. 测试上传功能
1. 编译运行小程序
2. 进入 `小说列表` 页面
3. 点击 `📤 上传` 按钮
4. 选择一个 TXT 或 EPUB 文件
5. 点击 `批量上传到云端`
6. 如果不再报错 `-501000`，说明部署成功

### 3. 测试阅读功能
1. 在小说列表中点击任意书籍
2. 如果能正常显示章节并阅读，说明 `parseNovel` 工作正常

---

## 🔧 部署后配置

### parseNovel 云函数配置

**内存**：256MB（推荐）  
**超时时间**：20秒（推荐）  
**环境变量**：无需配置

如需调整：
1. 进入云开发控制台
2. 点击 `云函数` → `parseNovel`
3. 点击 `版本管理` → `配置`
4. 调整内存和超时时间

---

## 🐛 常见问题

### Q1: 部署时提示 "依赖安装失败"
**A**: 
1. 检查网络连接
2. 确认 `package.json` 文件存在
3. 手动安装依赖：
   ```bash
   cd cloudfunctions/parseNovel
   npm install
   ```
4. 然后选择 **"上传并部署：所有文件"**

### Q2: 部署后仍然报错 -501000
**A**:
1. 确认环境ID正确（config/env.js）
2. 重新编译小程序
3. 清除缓存后再试
4. 在云开发控制台确认函数确实存在

### Q3: 解析文件时超时
**A**:
1. 增加云函数超时时间（最高60秒）
2. 减小上传文件大小（建议 <5MB）
3. 检查文件格式是否正确

### Q4: 上传成功但无法阅读
**A**:
1. 检查 `novels` 数据库集合是否已创建
2. 查看云函数日志排查错误
3. 确认文件格式符合要求（UTF-8 或 GBK 的 TXT，标准的 EPUB）

---

## 📊 云函数使用情况监控

### 查看调用次数和日志
1. 打开云开发控制台
2. 点击 `云函数` → `parseNovel`
3. 点击 `日志` 标签
4. 可以看到每次调用的详细信息

### 性能优化建议
- 单个文件解析平均耗时：2-5秒
- 建议文件大小：<10MB
- 批量上传建议：每次不超过5个文件
- 如果文件较大，考虑分章上传

---

## 🎓 技术细节

### parseNovel 云函数功能
1. **下载文件**：从云存储下载完整文件
2. **编码识别**：自动识别 UTF-8 / GBK 编码
3. **章节分割**：
   - 支持 "第X章"
   - 支持 "Chapter X"
   - 支持自定义章节标记
4. **EPUB解析**：
   - 解压 ZIP 文件
   - 读取 OPF 元数据
   - 提取 HTML 章节
   - 清理 HTML 标签
5. **返回数据**：章节数组（标题+内容）

### 数据流程
```
小说文件
   ↓ 上传
云存储（完整文件）
   ↓ fileID
novels 数据集合（元数据）
   ↓ 点击阅读
parseNovel 云函数
   ↓ 解析
章节数组
   ↓ 缓存
本地 storage
   ↓ 显示
阅读页面
```

---

## 📝 检查清单

部署前确认：
- ✅ 云开发环境已开通
- ✅ 环境ID配置正确（config/env.js）
- ✅ `novels` 数据库集合已创建
- ✅ `parseNovel` 文件夹内容完整

部署后验证：
- ✅ 云函数列表中能看到 `parseNovel`
- ✅ 状态显示为"已部署"
- ✅ 上传书籍不报错
- ✅ 点击书籍能正常阅读

---

**当前环境信息**
- 云环境ID: cloud1-3ge5gomsffe800a7
- 管理员OpenID: oVAxOvrDAY9Q0qG8WBnRxO3_m1nw
- 云函数目录: F:/CSFC/cloudfunctions/parseNovel

**下一步**：
1. 打开微信开发者工具
2. 右键 `cloudfunctions/parseNovel`
3. 点击 **"上传并部署：云端安装依赖"**
4. 等待完成
5. 测试上传和阅读功能

部署完成后，您就可以正常使用小说阅读功能了！📚
