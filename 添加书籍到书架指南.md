# 添加《我 中国队长》到书架 - 操作指南

## 📅 日期
2025年11月22日

---

## 📚 书籍信息

- **书名**：我 中国队长
- **文件路径**：`cloud://cloud1-3ge5gomsffe800a7.636c-cloud1-3ge5gomsffe800a7-1373366709/小说/我 中国队长.txt`
- **文件大小**：> 10 MB
- **格式**：TXT

---

## 🚀 方法一：使用云函数（推荐）

### 步骤1：部署云函数

1. **打开微信开发者工具**
2. **找到云函数目录**：`cloudfunctions/addBookToShelf/`
3. **右键点击 `addBookToShelf` 文件夹**
4. **选择"上传并部署：云端安装依赖"**
5. **等待部署完成**（约30秒）

### 步骤2：在小程序中添加测试页面

#### 2.1 添加页面路径到 app.json

打开 `miniprogram/app.json`，在 `pages` 数组中添加：

```json
{
  "pages": [
    "pages/index/index",
    "pages/novel/shelf/shelf",
    "pages/test/addBook"  ← 添加这一行
    // ...其他页面
  ]
}
```

#### 2.2 运行小程序并访问测试页面

在微信开发者工具的控制台输入：
```javascript
wx.navigateTo({
  url: '/pages/test/addBook'
})
```

#### 2.3 点击"添加到书架"按钮

- 云函数会自动将书籍信息添加到 `novels` 数据库集合
- 成功后会提示跳转到书架

### 步骤3：验证书籍已添加

1. 返回"书架"页面（`pages/novel/shelf/shelf`）
2. 应该能看到《我 中国队长》已出现在列表中
3. 点击书籍卡片即可开始阅读

---

## 🎯 方法二：直接在云开发控制台添加

### 步骤1：打开云开发控制台

1. 在微信开发者工具中，点击顶部菜单"云开发"
2. 选择"数据库"

### 步骤2：进入 novels 集合

1. 在左侧集合列表中找到 `novels`
2. 点击打开

### 步骤3：添加记录

点击"添加记录"按钮，输入以下JSON数据：

```json
{
  "name": "我 中国队长",
  "author": "未知作者",
  "intro": "一本超过10MB的大型小说，讲述中国队长的故事。",
  "category": "未分类",
  "format": "TXT",
  "fileID": "cloud://cloud1-3ge5gomsffe800a7.636c-cloud1-3ge5gomsffe800a7-1373366709/小说/我 中国队长.txt",
  "cloudPath": "小说/我 中国队长.txt",
  "size": 10485760,
  "sizeText": "> 10 MB",
  "uploadTime": 1700000000000
}
```

**注意**：`uploadTime` 可以填写当前时间戳，或者留空让系统自动生成。

### 步骤4：点击"确定"

记录会自动添加到数据库，系统会自动添加 `_id` 和 `_openid` 字段。

---

## 📱 方法三：使用开发者工具控制台

在微信开发者工具的控制台中执行以下代码：

```javascript
// 调用云函数添加书籍
wx.cloud.callFunction({
  name: 'addBookToShelf',
  data: {
    name: '我 中国队长',
    author: '未知作者',
    intro: '一本超过10MB的大型小说，讲述中国队长的故事。',
    category: '未分类',
    format: 'TXT',
    fileID: 'cloud://cloud1-3ge5gomsffe800a7.636c-cloud1-3ge5gomsffe800a7-1373366709/小说/我 中国队长.txt',
    cloudPath: '小说/我 中国队长.txt',
    size: 10485760,
    sizeText: '> 10 MB'
  },
  success: res => {
    console.log('添加成功:', res);
    wx.showToast({
      title: '添加成功',
      icon: 'success'
    });
  },
  fail: err => {
    console.error('添加失败:', err);
    wx.showToast({
      title: '添加失败',
      icon: 'none'
    });
  }
});
```

---

## 🧪 验证书籍是否添加成功

### 方法1：查看书架页面
1. 打开小程序
2. 进入"书架"页面
3. 检查是否显示《我 中国队长》

### 方法2：查看数据库
1. 打开云开发控制台
2. 进入"数据库" → `novels` 集合
3. 查找是否有 `name: "我 中国队长"` 的记录

### 方法3：尝试阅读
1. 在书架中点击《我 中国队长》
2. 系统会调用 `parseNovel` 云函数解析章节
3. 解析完成后会跳转到阅读器页面

---

## ⚠️ 注意事项

### 1. 关于大文件（> 10MB）

您的书籍超过10MB，解析时需要注意：

- **首次打开需要时间**：解析可能需要30-60秒
- **章节保存到云端**：章节会自动保存到 `novel_chapters` 集合
- **后续打开很快**：第二次打开时直接从数据库读取

### 2. 云函数超时设置

如果解析超时，可以修改 `shelf.js` 中的超时时间：

```javascript
const result = await wx.cloud.callFunction({
  name: 'parseNovel',
  data: {
    fileID: book.fileID,
    format: book.format,
    novelId: book.id
  },
  config: {
    timeout: 60000  // 60秒（可以改为120000，即120秒）
  }
});
```

### 3. 数据库权限

确保 `novels` 和 `novel_chapters` 集合的权限设置正确：

#### novels 集合权限：
```json
{
  "read": true,
  "write": "doc._openid == auth.openid"
}
```

#### novel_chapters 集合权限：
```json
{
  "read": true,
  "write": "doc._openid == auth.openid"
}
```

### 4. 如果解析失败

可能的原因和解决方案：

| 错误 | 原因 | 解决方案 |
|------|------|---------|
| 超时 | 文件太大 | 增加 timeout 时间 |
| 文件不存在 | fileID 错误 | 检查云存储路径 |
| 解析失败 | 文件格式问题 | 确认是TXT格式且编码正确 |
| 权限错误 | 数据库权限不足 | 检查集合权限设置 |

---

## 📊 数据库结构

### novels 集合（书籍元数据）

```javascript
{
  _id: "auto_generated_id",
  _openid: "your_openid",
  name: "我 中国队长",
  author: "未知作者",
  intro: "一本超过10MB的大型小说...",
  category: "未分类",
  format: "TXT",
  fileID: "cloud://...",
  cloudPath: "小说/我 中国队长.txt",
  size: 10485760,
  sizeText: "> 10 MB",
  uploadTime: 1700000000000
}
```

### novel_chapters 集合（章节内容）

解析后会自动生成：

```javascript
{
  _id: "chapter_id_1",
  _openid: "your_openid",
  novelId: "book_id_from_novels",
  chapterId: 0,
  title: "第一章 开始",
  content: "章节正文内容...",
  link: "chapter_0",
  createTime: "2025-11-22"
}
```

---

## 🎯 完整流程图

```
1. 添加书籍到 novels 集合
         ↓
2. 在书架页面显示书籍
         ↓
3. 用户点击书籍卡片
         ↓
4. 系统检查是否已有章节（novel_chapters）
         ↓
   ├─ 有章节 → 直接打开阅读器
   └─ 无章节 → 调用 parseNovel 云函数
                    ↓
              解析TXT文件为章节
                    ↓
              保存到 novel_chapters 集合
                    ↓
              打开阅读器
```

---

## 🔗 相关文件

### 云函数
- `cloudfunctions/addBookToShelf/index.js` - 添加书籍云函数
- `cloudfunctions/parseNovel/index.js` - 解析小说云函数

### 小程序页面
- `miniprogram/pages/novel/shelf/shelf.js` - 书架页面
- `miniprogram/pages/novel/reader/reader.js` - 阅读器页面
- `miniprogram/pages/test/addBook.js` - 测试页面（临时）

### 数据库集合
- `novels` - 书籍元数据
- `novel_chapters` - 章节内容
- `users` - 用户信息和阅读进度

---

## ✅ 检查清单

完成以下步骤后，书籍应该成功添加到书架：

- [ ] 云函数 `addBookToShelf` 已部署
- [ ] 测试页面已添加到 `app.json`
- [ ] 在测试页面点击"添加到书架"按钮
- [ ] 提示"添加成功"
- [ ] 在书架页面能看到《我 中国队长》
- [ ] 点击书籍能正常跳转到阅读器
- [ ] 首次打开会解析章节（需要等待）
- [ ] 后续打开可以直接阅读

---

## 💡 常见问题

### Q1: 点击书籍后一直显示"加载中"？
**A**: 可能是解析超时，建议：
1. 增加 timeout 时间到120秒
2. 检查云函数日志
3. 确认文件格式正确

### Q2: 书架页面不显示书籍？
**A**: 检查：
1. 数据库中是否有记录
2. `novels` 集合权限是否设置为"所有用户可读"
3. 刷新书架页面

### Q3: 显示"解析失败"？
**A**: 可能的原因：
1. fileID 路径错误
2. 文件不是标准TXT格式
3. 文件编码问题（应为UTF-8、GBK等）

---

**创建时间**：2025年11月22日  
**状态**：✅ 准备就绪，可以开始添加书籍
