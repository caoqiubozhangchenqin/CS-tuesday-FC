# 公共小说系统部署指南

## 📋 部署步骤总览

1. ✅ 配置数据库（10分钟）
2. ✅ 部署云函数（5分钟）
3. ✅ 上传测试小说（15分钟）
4. ✅ 测试功能（10分钟）

**总计：40分钟**

---

## 第一步：配置数据库（必须）

### 1.1 创建数据库集合

打开微信开发者工具 → 云开发 → 数据库，按照以下步骤操作：

#### 创建 novels 集合（公共小说库）

1. 点击「添加集合」
2. 集合名称：`novels`
3. 点击「权限设置」标签
4. 选择「自定义安全规则」
5. 输入以下 JSON：

```json
{
  "read": true,
  "write": false
}
```

6. 点击「保存」

**说明**：所有用户可读，只能通过云函数写入。

---

#### 创建 reading_progress 集合（阅读进度）

1. 点击「添加集合」
2. 集合名称：`reading_progress`
3. 权限设置：

```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

4. 点击「保存」

**说明**：用户只能读写自己的阅读进度。

---

#### 创建 user_shelf 集合（用户书架）

1. 点击「添加集合」
2. 集合名称：`user_shelf`
3. 权限设置：

```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

4. 点击「保存」

---

### 1.2 验证集合创建成功

在小程序开发者工具的控制台执行：

```javascript
// 测试 novels 集合
wx.cloud.database().collection('novels').get().then(console.log);

// 测试 reading_progress 集合
wx.cloud.database().collection('reading_progress').get().then(console.log);

// 测试 user_shelf 集合
wx.cloud.database().collection('user_shelf').get().then(console.log);
```

如果都能正常返回（即使是空数组），说明创建成功。

---

## 第二步：部署云函数

### 2.1 获取你的 openid（重要！）

在小程序中任意页面执行：

```javascript
wx.cloud.callFunction({
  name: 'login',
  success: res => {
    console.log('你的 openid:', res.result.openid);
    // 复制这个 openid！
  }
});
```

**复制输出的 openid**，下一步要用。

---

### 2.2 配置管理员 openid

打开文件：`cloudfunctions/adminUploadNovel/index.js`

找到第 26 行左右：

```javascript
const ADMIN_LIST = [
  'oXXXX-your-admin-openid-1',  // 替换为你的 openid
  'oXXXX-your-admin-openid-2'   // 可以添加多个管理员
];
```

**替换成你刚才复制的 openid**：

```javascript
const ADMIN_LIST = [
  'oABCD-你复制的openid-1234567',  // 替换为你的
];
```

保存文件。

---

### 2.3 部署云函数

1. 在开发者工具中，右键 `cloudfunctions/adminUploadNovel` 文件夹
2. 选择「上传并部署：云端安装依赖（不上传 node_modules）」
3. 等待部署完成（约 30秒）

**验证部署成功**：

云开发控制台 → 云函数 → 查看是否有 `adminUploadNovel` 函数

---

## 第三步：上传测试小说

### 3.1 准备测试小说文件

创建一个测试 TXT 文件：`test_novel.txt`

```
第一章 开始

这是测试小说的内容。

每页显示大约 500 个字符。

你可以准备更长的内容来测试翻页功能。

第二章 继续

继续添加内容...

（建议至少 3000 字以上，才能测试多页翻页）
```

---

### 3.2 上传文件到云存储

1. 云开发控制台 → 云存储
2. 点击「上传文件」
3. 选择刚才创建的 `test_novel.txt`
4. 上传路径：`novels/test_novel.txt`
5. 上传完成后，**复制文件的 fileID**

fileID 格式类似：`cloud://env-xxx.xxx/novels/test_novel.txt`

---

### 3.3 调用云函数添加小说到数据库

在小程序控制台执行：

```javascript
wx.cloud.callFunction({
  name: 'adminUploadNovel',
  data: {
    title: '测试小说',
    author: '测试作者',
    category: '古典名著',
    tags: ['测试', '示例'],
    description: '这是一本测试小说',
    coverUrl: '',  // 封面URL（可选）
    fileID: 'cloud://你的环境ID.xxxx/novels/test_novel.txt',  // 替换为实际的 fileID
    charsPerPage: 500
  },
  success: res => {
    console.log('上传成功:', res);
    // 记录返回的 novelId
  },
  fail: err => {
    console.error('上传失败:', err);
  }
});
```

**成功标志**：

```json
{
  "success": true,
  "novelId": "novel_xxxxx",
  "data": {
    "title": "测试小说",
    "totalPages": 6,
    "totalChars": 3000
  }
}
```

---

### 3.4 验证数据库中有记录

云开发控制台 → 数据库 → novels 集合

应该能看到刚才添加的小说记录。

---

## 第四步：测试功能

### 4.1 测试书城页面

1. 在开发者工具中编译小程序
2. 找到书城入口（你可能需要在首页添加跳转按钮）
3. 临时测试：在控制台执行

```javascript
wx.navigateTo({
  url: '/pages/novel/bookstore/bookstore'
});
```

**预期结果**：
- ✅ 能看到「测试小说」
- ✅ 显示作者、分类等信息

---

### 4.2 测试阅读器

点击「测试小说」卡片，应该进入阅读器页面。

**预期结果**：
- ✅ 能看到小说内容
- ✅ 可以左右滑动翻页
- ✅ 底部显示页码（如 "1/6"）
- ✅ 点击屏幕中央弹出菜单

---

### 4.3 测试进度保存

1. 阅读到第 3 页
2. 关闭小说页面
3. 重新打开该小说

**预期结果**：
- ✅ 自动跳转到第 3 页（恢复进度）

---

### 4.4 测试书架功能

1. 在书城点击小说右上角的「+」按钮
2. 提示「已加入书架」
3. 返回书架页面

**预期结果**：
- ✅ 书架中能看到该小说
- ✅ 显示阅读进度百分比

---

## 第五步：添加更多小说

### 方法 1：使用云函数（推荐）

准备多个 TXT 文件，重复第三步的操作。

### 方法 2：在云开发控制台手动添加

1. 上传 TXT 文件到云存储
2. 在 novels 集合中手动添加记录

**记录格式**：

```json
{
  "title": "西游记",
  "author": "吴承恩",
  "category": "古典名著",
  "tags": ["神话", "经典"],
  "description": "中国古典四大名著之一",
  "cover": "",
  "fileID": "cloud://xxx/novels/xiyouji.txt",
  "fileSize": 1024000,
  "totalChars": 500000,
  "totalPages": 1000,
  "charsPerPage": 500,
  "viewCount": 0,
  "favoriteCount": 0,
  "uploadTime": 1700654321000,
  "updateTime": 1700654321000,
  "status": "published",
  "isRecommended": false
}
```

---

## 🎯 完整测试清单

### 数据库
- [ ] novels 集合已创建，权限正确
- [ ] reading_progress 集合已创建，权限正确
- [ ] user_shelf 集合已创建，权限正确

### 云函数
- [ ] adminUploadNovel 已部署
- [ ] 管理员 openid 已配置
- [ ] 云函数调用成功

### 小说数据
- [ ] 至少上传 1 本测试小说
- [ ] novels 集合中有记录
- [ ] 文件已上传到云存储

### 前端功能
- [ ] 书城页面能正常显示小说
- [ ] 点击小说能进入阅读器
- [ ] 阅读器能正常翻页
- [ ] 阅读进度能保存和恢复
- [ ] 书架功能正常

---

## ⚠️ 常见问题

### Q1: 书城页面显示"数据库未初始化"

**A**: 检查是否按照第一步创建了 novels 集合。

---

### Q2: 调用 adminUploadNovel 返回"权限不足"

**A**: 检查 `index.js` 中的 ADMIN_LIST 是否配置了正确的 openid。

---

### Q3: 阅读器打开后显示"加载失败"

**A**: 
1. 检查 fileID 是否正确
2. 检查云存储中是否有该文件
3. 查看控制台错误日志

---

### Q4: 进度保存失败，报权限错误

**A**: 检查 reading_progress 集合的权限设置是否为：

```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

---

### Q5: 如何计算 totalPages？

**A**: 
- 获取文件总字数（totalChars）
- totalPages = Math.ceil(totalChars / 500)
- 例如：3000 字 ÷ 500 = 6 页

---

## 📱 添加入口

在首页添加跳转按钮（可选）：

```xml
<!-- pages/index/index.wxml -->
<button bindtap="goToBookstore">进入书城</button>
```

```javascript
// pages/index/index.js
goToBookstore() {
  wx.navigateTo({
    url: '/pages/novel/bookstore/bookstore'
  });
}
```

---

## 🚀 上线前检查

- [ ] 所有测试小说内容合法（无版权问题）
- [ ] 数据库权限配置正确
- [ ] 云函数已部署
- [ ] 完整测试通过
- [ ] 清理测试数据（可选）

---

## 📞 需要帮助？

如果遇到问题：
1. 查看控制台错误日志
2. 检查云开发日志（云函数 → 日志）
3. 参考文档：`公共小说系统重构方案-横向翻页.md`

---

**部署完成后**，你应该能看到：
- ✅ 书城展示公共小说列表
- ✅ 横向翻页阅读器流畅运行
- ✅ 阅读进度自动保存
- ✅ 用户书架正常工作

**祝部署顺利！** 🎉
