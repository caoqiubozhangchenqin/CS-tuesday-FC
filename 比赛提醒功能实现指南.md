# 比赛提醒功能实现指南

## 功能概述

为五大联赛赛程页面添加比赛提醒功能，用户可以为未开始的比赛设置提醒，在比赛开始前收到推送通知。

## 实现步骤

### 1. 数据库集合创建

在微信开发者工具的云开发控制台中创建以下集合：

#### 集合名：`match_reminders`

字段结构：
```javascript
{
  _id: String,           // 自动生成
  userId: String,        // 用户openid
  matchId: String,       // 比赛ID
  createdAt: Date,       // 创建时间
  status: String,        // 'active' | 'cancelled'
  cancelledAt: Date      // 取消时间（可选）
}
```

索引设置：
- userId + matchId（唯一索引）
- status（普通索引）

### 2. 云函数部署

#### 2.1 部署 `manageMatchReminders` 云函数
```bash
# 在微信开发者工具中右键 manageMatchReminders 文件夹
# 选择 "上传并部署：云端安装依赖"
```

#### 2.2 部署 `sendMatchReminders` 云函数
```bash
# 在微信开发者工具中右键 sendMatchReminders 文件夹
# 选择 "上传并部署：云端安装依赖"
```

### 3. 消息推送配置

#### 3.1 配置消息模板
1. 进入微信公众平台
2. 在"模板消息"中添加新模板
3. 模板内容示例：
   ```
   比赛提醒通知
   比赛：{{thing1.DATA}}
   时间：{{time2.DATA}}
   提醒：{{thing3.DATA}}
   ```

#### 3.2 获取模板ID
- 记录模板ID，用于云函数中的 `templateId`

#### 3.3 用户订阅消息
在赛程页面添加订阅消息的逻辑：

```javascript
// 在 toggleReminder 函数中添加订阅逻辑
if (!isCurrentlySet) {
  // 设置提醒时请求订阅权限
  wx.requestSubscribeMessage({
    tmplIds: ['YOUR_TEMPLATE_ID'],
    success: (res) => {
      if (res['YOUR_TEMPLATE_ID'] === 'accept') {
        // 用户同意订阅，继续设置提醒
        this.setReminder(matchId);
      } else {
        wx.showToast({
          title: '需要订阅消息权限',
          icon: 'none'
        });
      }
    }
  });
}
```

### 4. 定时任务设置

#### 4.1 云函数定时触发器
在 `sendMatchReminders` 云函数的 `package.json` 中添加定时配置：

```json
{
  "triggers": [
    {
      "name": "sendMatchReminders",
      "type": "timer",
      "config": "0 */5 * * * * *"  // 每5分钟执行一次
    }
  ]
}
```

#### 4.2 手动测试
可以通过云开发控制台手动调用云函数进行测试。

### 5. 完善云函数逻辑

#### 5.1 更新 `sendMatchReminders/index.js`

完善获取即将开始比赛的逻辑：

```javascript
// 获取即将开始的比赛（未来30分钟内）
async function getUpcomingMatches() {
  // 调用Football-Data.org API获取最新比赛数据
  const apiKey = 'c4906718aabe4287b5963a412e4c81ce';

  // 获取当前时间和未来30分钟的时间
  const now = new Date();
  const thirtyMinutesLater = new Date(now.getTime() + 30 * 60 * 1000);

  const dateFrom = formatDate(now);
  const dateTo = formatDate(thirtyMinutesLater);

  // 调用API获取比赛数据
  const response = await new Promise((resolve) => {
    wx.request({
      url: `https://api.football-data.org/v4/matches?dateFrom=${dateFrom}&dateTo=${dateTo}`,
      method: 'GET',
      header: {
        'X-Auth-Token': apiKey
      },
      success: (res) => {
        if (res.statusCode === 200 && res.data.matches) {
          resolve(res.data.matches);
        } else {
          resolve([]);
        }
      },
      fail: () => resolve([])
    });
  });

  return response;
}

// 格式化日期
function formatDate(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}
```

#### 5.2 更新推送逻辑

在 `sendReminderToUser` 函数中使用正确的模板ID：

```javascript
const result = await cloud.openapi.subscribeMessage.send({
  touser: userId,
  templateId: 'YOUR_ACTUAL_TEMPLATE_ID', // 替换为实际模板ID
  data: {
    thing1: {
      value: matchInfo.substring(0, 20) // 限制长度
    },
    time2: {
      value: timeString
    },
    thing3: {
      value: '点击查看比赛详情'
    }
  }
});
```

### 6. 前端优化

#### 6.1 添加加载状态
在设置/取消提醒时显示加载状态，避免重复点击。

#### 6.2 错误处理
添加网络错误、重试机制等。

#### 6.3 提醒状态同步
确保页面刷新后提醒状态正确显示。

## 使用说明

1. 用户进入赛程页面
2. 点击未开始比赛的闹钟按钮
3. 同意订阅消息权限
4. 设置成功后按钮变为"已提醒"状态
5. 比赛开始前30分钟会收到推送提醒
6. 可以再次点击取消提醒

## 注意事项

1. **权限配置**：确保小程序有消息推送权限
2. **模板ID**：需要替换为实际的微信模板ID
3. **API限制**：Football-Data.org API有调用频率限制
4. **时区处理**：注意UTC时间与本地时间的转换
5. **错误处理**：添加完善的错误处理和重试机制

## 测试建议

1. 使用测试账号测试提醒功能
2. 验证不同时间段的提醒推送
3. 测试取消提醒功能
4. 验证网络异常情况下的处理