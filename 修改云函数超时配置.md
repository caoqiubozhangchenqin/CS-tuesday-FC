# 🔧 修改云函数超时时间（云端配置）

## 🚨 问题原因

您的云函数已部署，但**超时时间仍然是默认的 3 秒**，不够用！

需要在**云开发控制台**修改为 60 秒。

---

## ✅ 解决方案（2分钟）

### 方法一：在云开发控制台修改（推荐）

#### 第 1 步：打开云开发控制台

1. 点击微信开发者工具顶部的 **"云开发"** 按钮
2. 或访问：https://console.cloud.tencent.com/tcb

#### 第 2 步：找到云函数

1. 点击左侧菜单 **"云函数"**
2. 在云函数列表中找到 **`adminUploadNovel`**
3. **点击函数名称**进入详情页

#### 第 3 步：修改超时配置

1. 在云函数详情页，找到 **"函数配置"** 标签
2. 找到 **"超时时间"** 设置
3. 将 **3秒** 改为 **60秒**
4. 点击 **"保存"** 按钮

#### 第 4 步：等待配置生效

- 等待 10-30 秒
- 刷新页面确认修改成功

---

### 方法二：重新部署（自动应用配置）

如果方法一不行，重新部署云函数：

1. 在微信开发者工具中
2. 右键点击 `cloudfunctions/adminUploadNovel`
3. 选择 **"上传并部署：云端安装依赖"**
4. 等待部署完成
5. `config.json` 中的 `"timeout": 60` 会自动应用

---

## 🔍 验证超时配置

在调试器控制台运行：

```javascript
// 测试一个不会立即返回的调用
wx.cloud.callFunction({
  name: 'adminUploadNovel',
  data: {
    title: '测试',
    author: '测试',
    fileID: 'cloud://test.txt', // 假的fileID，会触发错误但不会立即超时
    content: '测试内容'.repeat(10000) // 大量数据
  },
  success: res => {
    console.log('✅ 返回结果（说明没有3秒超时）:', res.result)
    console.log('⏱️ 如果超过3秒才返回，说明超时配置生效了')
  },
  fail: err => {
    if (err.errMsg.includes('3 seconds')) {
      console.error('❌ 仍然是3秒超时！请在云端控制台修改')
    } else {
      console.log('✅ 不是超时错误，说明超时配置已生效')
      console.log('错误信息:', err.errMsg)
    }
  }
})
```

---

## 📊 配置对比

| 配置项 | 默认值 | 应该改为 | 位置 |
|--------|--------|----------|------|
| 超时时间 | 3秒 | 60秒 | 云端控制台 |
| 内存 | 256MB | 512MB（可选） | 云端控制台 |

---

## 🎯 完整流程总结

1. ✅ **部署云函数**（已完成）
   - 验证脚本返回了结果

2. ⚠️ **修改超时配置**（当前步骤）
   - 方法一：云端控制台修改
   - 方法二：重新部署

3. ✅ **测试上传**
   - 运行验证脚本
   - 尝试上传小说

---

## 💡 为什么会超时？

### 文件处理流程：

```
1. 上传 TXT 到云存储 ✅ 成功（2-3秒）
2. 调用云函数 ❌ 超时（需要5-10秒，但限制3秒）
   ├── 下载 TXT 文件
   ├── 读取文件内容
   ├── 计算字数和页数
   └── 保存到数据库
```

**解决：** 把超时限制从 3秒 改为 60秒，给云函数足够时间处理。

---

## 🔧 如果修改后仍然超时

### 检查清单：

1. ✅ 云端控制台显示 60秒？
2. ✅ 重新部署了云函数？
3. ✅ 等待了 30秒 让配置生效？
4. ✅ 刷新了小程序（Ctrl+B）？
5. ✅ 文件不超过 10MB？

如果都确认了还是超时，可能是：

- **网络问题**：云函数下载文件慢
- **文件太大**：建议 < 5MB
- **云端资源不足**：升级云开发套餐

---

## 📞 快速命令

```javascript
// 1. 查看云函数列表
// 云开发 → 云函数 → 查看 adminUploadNovel

// 2. 验证超时配置
wx.cloud.callFunction({
  name: 'adminUploadNovel',
  data: { title: '测试', author: '测试', content: 'test' },
  success: res => console.log('✅', res.result),
  fail: err => console.error('❌', err.errMsg)
})

// 3. 测试上传
wx.navigateTo({ url: '/pages/admin/upload-novel/upload-novel' })
```

---

**现在请立即去云开发控制台，将 adminUploadNovel 的超时时间改为 60秒！** ⏱️
