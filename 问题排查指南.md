# 📋 《我 中国队长》添加失败 - 问题排查指南

## 🔍 可能的原因和解决方案

### 1️⃣ 云函数未部署

**症状**：控制台提示"云函数不存在"

**检查方法**：
```javascript
// 在微信开发者工具控制台执行
wx.cloud.callFunction({
  name: 'addBookToShelf',
  data: {}
}).then(res => console.log('云函数存在')).catch(err => console.log('云函数不存在'));
```

**解决方案**：
1. 在微信开发者工具左侧找到 `cloudfunctions/addBookToShelf`
2. 右键点击 → 选择 **"上传并部署：云端安装依赖"**
3. 等待部署完成（约30秒）
4. 看到"上传成功"提示

---

### 2️⃣ 数据库集合不存在

**症状**：提示"集合不存在"或 errCode -502005

**检查方法**：
在**云开发控制台** → **数据库**中查看是否有 `novels` 集合

**解决方案**：
1. 打开云开发控制台
2. 点击"数据库"
3. 点击"添加集合"
4. 集合名称输入：`novels`
5. 权限设置：选择"仅创建者可读写"
6. 点击"确定"

---

### 3️⃣ 数据库权限问题

**症状**：提示"没有权限"或 errCode -502003

**解决方案**：
1. 打开云开发控制台 → 数据库 → `novels` 集合
2. 点击"权限设置"
3. 修改为：
```json
{
  "read": true,
  "write": "doc._openid == auth.openid"
}
```
4. 保存

---

### 4️⃣ 代码没有执行

**症状**：控制台没有任何输出

**解决方案**：
确保您在**微信开发者工具的控制台**中执行代码：
- 位置：微信开发者工具底部 → **Console** 标签
- 不是 VS Code 的终端！

---

### 5️⃣ 书籍已添加但书架不显示

**症状**：数据库有记录，但书架页面看不到

**检查方法**：
```javascript
// 在控制台执行
wx.cloud.database().collection('novels')
  .where({ name: '我 中国队长' })
  .get()
  .then(res => console.log('数据库中的书:', res.data));
```

**解决方案**：
1. **刷新书架页面**：
   - 在模拟器中重新点击"书架"标签
   - 或执行：`getCurrentPages()[0].onShow()`

2. **检查 openid**：
   - 如果 `novels` 集合权限设置为"仅创建者可读写"
   - 需要改为"所有用户可读，仅创建者可写"

3. **检查书架代码**：
   - 确认 `shelf.js` 的 `loadCloudBooks()` 方法正确

---

### 6️⃣ 文件 ID 错误

**症状**：书籍添加成功，但点击后无法打开

**检查方法**：
```javascript
// 验证文件是否存在
wx.cloud.downloadFile({
  fileID: 'cloud://cloud1-3ge5gomsffe800a7.636c-cloud1-3ge5gomsffe800a7-1373366709/小说/我 中国队长.txt'
}).then(res => console.log('文件存在')).catch(err => console.log('文件不存在'));
```

**解决方案**：
确认云存储中确实有这个文件，路径和名称完全正确

---

## 🎯 推荐的诊断流程

### 第1步：运行完整诊断
在微信开发者工具控制台复制执行 `diagnose-book.js` 的内容：

```javascript
// 完整诊断脚本（见 diagnose-book.js）
```

查看输出，找到所有带 ❌ 的错误

---

### 第2步：直接添加（跳过云函数）
如果云函数有问题，直接用数据库 API 添加：

在微信开发者工具控制台执行 `add-book-directly.js` 的内容：

```javascript
wx.cloud.database().collection('novels').add({
  data: {
    name: '我 中国队长',
    author: '未知作者',
    intro: '一本超过10MB的大型小说',
    category: '未分类',
    format: 'TXT',
    fileID: 'cloud://cloud1-3ge5gomsffe800a7.636c-cloud1-3ge5gomsffe800a7-1373366709/小说/我 中国队长.txt',
    cloudPath: '小说/我 中国队长.txt',
    size: 10485760,
    sizeText: '> 10 MB',
    uploadTime: Date.now()
  }
}).then(res => {
  console.log('✅ 添加成功，ID:', res._id);
  wx.showToast({ title: '已添加', icon: 'success' });
});
```

---

### 第3步：验证和刷新
```javascript
// 验证书籍是否在数据库中
wx.cloud.database().collection('novels')
  .where({ name: '我 中国队长' })
  .count()
  .then(res => console.log('找到', res.total, '本《我 中国队长》'));

// 刷新书架页面
wx.reLaunch({ url: '/pages/novel/shelf/shelf' });
```

---

## 🔧 常见错误代码

| 错误码 | 含义 | 解决方案 |
|--------|------|---------|
| -502005 | 集合不存在 | 在云开发控制台创建 novels 集合 |
| -502003 | 权限不足 | 修改集合权限设置 |
| -504003 | 云函数超时 | 增加 timeout 或优化代码 |
| -404 | 云函数不存在 | 部署云函数到云端 |

---

## 📱 正确的操作位置

### ✅ 在微信开发者工具中执行：
```
微信开发者工具
  └─ 底部工具栏
      └─ Console 标签（控制台）← 在这里执行 JavaScript 代码
```

### ❌ 不要在这些地方执行：
- ❌ VS Code 终端（PowerShell/CMD）
- ❌ 浏览器控制台
- ❌ 代码编辑器
- ❌ 微信小程序页面的 JS 文件

---

## 🎯 快速验证清单

复制以下代码到**微信开发者工具控制台**，一次性检查所有问题：

```javascript
console.log('=== 快速验证 ===\n');

// 1. 检查数据库
wx.cloud.database().collection('novels').count().then(res => {
  console.log('✅ novels 集合存在，共', res.total, '本书');
}).catch(err => {
  console.log('❌ novels 集合问题:', err.errMsg);
});

// 2. 查找书籍
wx.cloud.database().collection('novels')
  .where({ name: '我 中国队长' })
  .get()
  .then(res => {
    if (res.data.length > 0) {
      console.log('✅ 《我 中国队长》已存在');
      console.log('   书籍ID:', res.data[0]._id);
      console.log('   如果书架看不到，请刷新页面');
    } else {
      console.log('❌ 《我 中国队长》不存在，需要添加');
    }
  });

// 3. 检查文件
wx.cloud.downloadFile({
  fileID: 'cloud://cloud1-3ge5gomsffe800a7.636c-cloud1-3ge5gomsffe800a7-1373366709/小说/我 中国队长.txt'
}).then(res => {
  console.log('✅ 云存储文件存在');
}).catch(err => {
  console.log('❌ 云存储文件不存在:', err.errMsg);
});

console.log('\n=== 验证完成 ===');
```

---

## 💡 如果还是不行

### 方案A：手动在云开发控制台添加

1. 打开**云开发控制台** → **数据库** → **novels** 集合
2. 点击**添加记录**
3. 粘贴以下 JSON：

```json
{
  "name": "我 中国队长",
  "author": "未知作者",
  "intro": "一本超过10MB的大型小说，讲述中国队长的故事。",
  "category": "未分类",
  "format": "TXT",
  "fileID": "cloud://cloud1-3ge5gomsffe800a7.636c-cloud1-3ge5gomsffe800a7-1373366709/小说/我 中国队长.txt",
  "cloudPath": "小说/我 中国队长.txt",
  "size": 10485760,
  "sizeText": "> 10 MB",
  "uploadTime": 1700650000000
}
```

4. 点击**确定**
5. 记录会自动添加 `_id` 和 `_openid`

### 方案B：提供错误信息

请告诉我：
1. 在控制台执行代码后的完整错误信息
2. 是否看到任何输出
3. 截图控制台的错误提示

---

**创建时间**：2025年11月22日  
**当前状态**：等待您的错误信息以便进一步诊断
