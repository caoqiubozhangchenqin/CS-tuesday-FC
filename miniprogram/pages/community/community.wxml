<!--pages/community/community.wxml-->
<bg src="{{bgImageUrl}}" overlayOpacity="0.3" blur="0" sizeMode="cover" repeat="false" />
<view class="container">
  <!-- 页面标题 -->
  <view class="page-title">
    <text class="title-icon">💬</text>
    <text>球迷留言板</text>
  </view>

  <!-- 发布留言区域 -->
  <view class="post-section">
    <view class="post-header">
      <text class="post-icon">✍️</text>
      <text>发表你的看法</text>
    </view>
    <view class="post-form">
      <textarea 
        class="message-input" 
        placeholder="分享你对比赛、球队的看法..." 
        value="{{newMessage}}" 
        bindinput="onMessageInput"
        maxlength="200"
        show-confirm-bar="{{false}}"
      ></textarea>
      <!-- 权限提示信息 - 仅在未完成评估或无球队时显示 -->
      <view wx:if="!isAdmin && (!hasUserInfo || userValue <= 0 || !selectedTeam)" class="permission-tip">
        <text wx:if="!hasUserInfo || userValue <= 0" class="tip-text">💡 请先完成身价评估</text>
        <text wx:if="!selectedTeam" class="tip-text">💡 请先选择球队</text>
      </view>
      <view class="post-actions">
        <view class="char-count">{{messageLength}}/200</view>
        <button class="post-btn" bindtap="submitMessage" disabled="{{!canPost}}">发布</button>
      </view>
    </view>
  </view>

  <!-- 留言列表 -->
  <view class="messages-section">
    <view class="section-header">
      <text class="section-icon">📝</text>
      <text>最新留言</text>
      <view class="sort-options">
        <text class="sort-btn {{sortBy === 'time' ? 'active' : ''}}" bindtap="setSortBy" data-type="time">最新</text>
        <text class="sort-btn {{sortBy === 'likes' ? 'active' : ''}}" bindtap="setSortBy" data-type="likes">热门</text>
      </view>
    </view>

    <!-- 留言列表 -->
    <view wx:if="{{!isLoading}}" class="messages-list">
      <view wx:for="{{messageList}}" wx:key="id" class="message-card">
        <view class="message-header">
          <view class="user-info">
            <!-- 优先显示用户头像，如果没有则显示默认图标 -->
            <image wx:if="{{item.avatarUrl}}" class="user-avatar" src="{{item.avatarUrl}}" mode="aspectFill"></image>
            <text wx:else class="user-avatar">👤</text>
            <view class="user-details">
              <text class="user-name">{{item.userId}}</text>
              <view class="user-stats">
                <text class="user-value">身价: ¥{{item.userValue}}万</text>
                <text wx:if="{{item.selectedTeam}}" class="user-team">{{item.selectedTeam}}</text>
              </view>
            </view>
            <text class="post-time">{{item.createTime}}</text>
          </view>
          <view class="message-actions">
            <view class="like-btn {{item.isLiked ? 'liked' : ''}}" bindtap="toggleLike" data-id="{{item.id}}">
              <text class="like-icon">{{item.isLiked ? '❤️' : '🤍'}}</text>
              <text class="like-count">{{item.likeCount}}</text>
            </view>
            <view class="reply-btn" bindtap="showReply" data-id="{{item.id}}">
              <text class="reply-icon">💬</text>
            </view>
          </view>
        </view>
        
        <view class="message-content">
          <text>{{item.content}}</text>
        </view>
        
        <!-- 回复区域 -->
        <view wx:if="{{item.showReply}}" class="reply-section">
          <textarea 
            class="reply-input" 
            placeholder="回复这条留言..." 
            value="{{item.replyText}}" 
            bindinput="onReplyInput" 
            data-id="{{item.id}}"
            maxlength="100"
          ></textarea>
          <view class="reply-actions">
            <button class="reply-submit-btn" bindtap="submitReply" data-id="{{item.id}}">回复</button>
            <button class="reply-cancel-btn" bindtap="hideReply" data-id="{{item.id}}">取消</button>
          </view>
        </view>
        
        <!-- 管理员删除按钮 - 右下角位置 -->
          <view wx:if="{{isAdmin}}" class="delete-btn" bindtap="deleteMessage" data-id="{{item.id}}">
            <text class="delete-icon">🗑️</text>
          </view>
          
          <!-- 回复列表 -->
          <view wx:if="{{item.replies && item.replies.length > 0}}" class="replies-list">
            <view wx:for="{{item.replies}}" wx:for-item="reply" wx:key="id" class="reply-item">
                <view class="reply-header">
                  <image wx:if="{{reply.avatarUrl}}" class="reply-avatar" src="{{reply.avatarUrl}}" mode="aspectFill"></image>
                  <text wx:else class="reply-avatar">👤</text>
                  <text class="reply-user">{{reply.userId}}</text>
            <text class="reply-time">{{reply.createTime}}</text>
          </view>
            <view class="reply-content">
              <text>{{reply.content}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 加载状态 -->
    <view wx:if="{{isLoading}}" class="loading-tip">正在加载留言...</view>
    
    <!-- 空状态 -->
    <view wx:if="{{!isLoading && messageList.length === 0}}" class="empty-tip">
      <text class="empty-icon">💭</text>
      <text>还没有留言，快来发表第一条吧！</text>
    </view>
  </view>
</view>
