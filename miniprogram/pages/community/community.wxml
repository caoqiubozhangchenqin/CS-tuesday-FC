<!--pages/community/community.wxml-->
<bg src="{{bgImageUrl}}" overlayOpacity="0.3" blur="0" sizeMode="cover" repeat="false" />
<view class="container">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <view class="page-title">
    <text class="title-icon">ğŸ’¬</text>
  <text>è”èµ›è®°å½•</text>
  </view>

  <!-- å‘å¸ƒç•™è¨€åŒºåŸŸ -->
  <view class="post-section">
    <view class="post-header">
      <text class="post-icon">âœï¸</text>
      <text>å‘å¸ƒè®°å½•</text>
    </view>
    <view class="post-form">
      <textarea
        class="message-input"
        placeholder="è®°å½•ä½ å¯¹æ¯”èµ›æˆ–çƒé˜Ÿçš„çœ‹æ³•..."
        value="{{newMessage}}"
        bindinput="onMessageInput"
        maxlength="200"
        show-confirm-bar="{{false}}"
      ></textarea>
      <view class="post-actions">
        <view class="char-count">{{messageLength}}/200</view>
        <button class="post-btn" bindtap="submitMessage" disabled="{{!canPost}}">å‘å¸ƒè®°å½•</button>
      </view>
    </view>
  </view>

  <!-- ç•™è¨€åˆ—è¡¨ -->
  <view class="messages-section">
    <view class="section-header">
      <text class="section-icon">ğŸ“</text>
      <text>æœ€æ–°è®°å½•</text>
      <view class="header-actions">
        <view class="refresh-btn" bindtap="refreshMessages">
          <text class="refresh-icon">ğŸ”„</text>
          <text>åˆ·æ–°</text>
        </view>
        <view class="sort-options">
          <text class="sort-btn {{sortBy === 'time' ? 'active' : ''}}" bindtap="setSortBy" data-type="time">æœ€æ–°</text>
          <text class="sort-btn {{sortBy === 'likes' ? 'active' : ''}}" bindtap="setSortBy" data-type="likes">çƒ­é—¨</text>
        </view>
      </view>
    </view>

    <!-- ç•™è¨€åˆ—è¡¨ -->
    <view wx:if="{{!isLoading}}" class="messages-list">
      <view wx:for="{{messageList}}" wx:key="id" class="message-card">
        <view class="message-header">
          <view class="user-info">
            <text class="user-avatar">ğŸ‘¤</text>
            <view class="user-details">
              <view class="user-name-row">
                <text class="user-name">{{item.userId}}</text>
                <text class="user-value {{item.userValue >= 1400 ? 'value-legendary' : item.userValue >= 1200 ? 'value-epic' : item.userValue >= 1000 ? 'value-rare' : item.userValue >= 800 ? 'value-uncommon' : 'value-common'}}">
                  Â¥{{item.userValue}}ä¸‡
                </text>
              </view>
              <view class="user-stats">
                <text wx:if="{{item.selectedTeam}}" class="user-team">{{item.selectedTeam}}</text>
              </view>
            </view>
          </view>
          <view class="message-actions">
            <view class="like-btn {{item.isLiked ? 'liked' : ''}}" bindtap="toggleLike" data-id="{{item.id}}">
              <text class="like-icon">{{item.isLiked ? 'â¤ï¸' : 'ğŸ¤'}}</text>
              <text class="like-count">{{item.likeCount}}</text>
            </view>
            <view class="reply-btn" bindtap="showReply" data-id="{{item.id}}">
              <text class="reply-icon">ğŸ’¬</text>
            </view>
          </view>
        </view>

        <view class="message-content">
          <text>{{item.content}}</text>
        </view>

        <!-- ç•™è¨€æ—¶é—´ - å³ä¸‹è§’ -->
        <view class="message-time">
          <text>{{item.createTime}}</text>
        </view>

        <!-- å›å¤åŒºåŸŸ -->
        <view wx:if="{{item.showReply}}" class="reply-section">
          <textarea
            class="reply-input"
            placeholder="å›å¤è¿™æ¡è®°å½•..."
            value="{{item.replyText}}"
            bindinput="onReplyInput"
            data-id="{{item.id}}"
            maxlength="100"
          ></textarea>
          <view class="reply-actions">
            <button class="reply-submit-btn" bindtap="submitReply" data-id="{{item.id}}">å›å¤</button>
            <button class="reply-cancel-btn" bindtap="hideReply" data-id="{{item.id}}">å–æ¶ˆ</button>
          </view>
        </view>

        <!-- ç®¡ç†å‘˜åˆ é™¤æŒ‰é’® - å³ä¸‹è§’ä½ç½® -->
        <view wx:if="{{isAdmin}}" class="delete-btn" bindtap="deleteMessage" data-id="{{item.id}}">
          <text class="delete-icon">ğŸ—‘ï¸</text>
        </view>

        <!-- å›å¤åˆ—è¡¨ -->
        <view wx:if="{{item.replies && item.replies.length > 0}}" class="replies-list">
          <view wx:for="{{item.replies}}" wx:for-item="reply" wx:key="id" class="reply-item">
            <view class="reply-header">
              <text class="reply-avatar">ğŸ‘¤</text>
              <text class="reply-user">{{reply.userId}}</text>
            </view>
            <view class="reply-content">
              <text>{{reply.content}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{isLoading}}" class="loading-tip">æ­£åœ¨åŠ è½½è®°å½•...</view>

    <!-- ç©ºçŠ¶æ€ -->
    <view wx:if="{{!isLoading && messageList.length === 0}}" class="empty-tip">
      <text class="empty-icon">ğŸ’­</text>
      <text>è¿˜æ²¡æœ‰è®°å½•ï¼Œå¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡å§ï¼</text>
    </view>
  </view>
</view>
