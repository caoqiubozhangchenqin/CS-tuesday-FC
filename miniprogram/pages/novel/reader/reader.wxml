<!-- pages/novel/reader/reader.wxml -->
<view class="container {{themeClass}}">    <!-- æœªè§£æå®Œæˆæç¤ºï¼ˆä»…äº‘ç«¯ä¹¦ç±ä¸”æ¥è¿‘æœ«å°¾ï¼‰ -->
    <view class="incomplete-parse-hint" wx:if="{{isCloud && needUnlock && parseRecord}}">
      <view class="hint-text">
        <text class="icon">ğŸ”’</text>
        <text>å·²è§£æ {{parseRecord.lastParsedChapter}}/{{parseRecord.totalChapters}} ç« </text>
      </view>
      <view class="continue-parse-btn" bindtap="continueParsingChapters">
        <text>è§£é”å 30 ç« </text>
      </view>
    </view>ä¾§æ‚¬æµ®èœå•æŒ‰é’® -->
  <view class="floating-menu-btn" bindtap="toggleMenu">
    <text class="menu-icon">â˜°</text>
  </view>

  <!-- é¡¶éƒ¨æ ‡é¢˜æ ï¼ˆç®€åŒ–ç‰ˆï¼Œåªæ˜¾ç¤ºä¹¦åï¼‰-->
  <view class="header" wx:if="{{showHeader}}">
    <view class="header-center">
      <text class="book-title">{{bookName}}</text>
    </view>
  </view>

  <!-- ç« èŠ‚å†…å®¹ï¼ˆæ»šåŠ¨æ¨¡å¼ï¼‰-->
  <scroll-view 
    class="content-scroll {{themeClass}}" 
    scroll-y="{{true}}"
    bindtap="toggleHeader"
    scroll-top="{{scrollTop}}"
    bindscroll="onScroll"
    refresher-enabled="{{true}}"
    refresher-threshold="80"
    refresher-triggered="{{pullDownRefreshing}}"
    bindrefresherrefresh="onPullDownRefresh"
  >
    <view class="content-container {{themeClass}}">
      <!-- ç¬¬ä¸€ç« æç¤º -->
      <view wx:if="{{!isLoading && chapterContent && currentChapterIndex === 0}}" class="start-hint">
        <text>ğŸ“– è¿™æ˜¯ç¬¬ä¸€ç« </text>
      </view>

      <!-- ç« èŠ‚æ ‡é¢˜ -->
      <view class="chapter-title">{{chapterTitle}}</view>
      
      <!-- åŠ è½½çŠ¶æ€ -->
      <view wx:if="{{isLoading}}" class="loading-state">
        <text class="loading-icon">ğŸ“–</text>
        <text class="loading-text">åŠ è½½ä¸­...</text>
      </view>

      <!-- ç« èŠ‚å†…å®¹ -->
      <view wx:if="{{!isLoading && chapterContent}}" class="chapter-content">
        <text class="content-text" style="font-size: {{fontSize}}px;" decode="{{true}}" space="{{true}}">{{chapterContent}}</text>
      </view>

      <!-- åŠ è½½å¤±è´¥ -->
      <view wx:if="{{!isLoading && !chapterContent}}" class="error-state">
        <text class="error-icon">ğŸ˜”</text>
        <text class="error-text">åŠ è½½å¤±è´¥</text>
        <view class="retry-btn" bindtap="retryLoad">
          <text>é‡è¯•</text>
        </view>
      </view>

      <!-- ç« èŠ‚åº•éƒ¨æŒ‰é’® -->
      <view wx:if="{{!isLoading && chapterContent && currentChapterIndex < totalChapters - 1}}" class="chapter-end-hint">
        <view class="hint-btn" bindtap="nextChapter">
          <text>â–¶ ä¸‹ä¸€ç« </text>
        </view>
      </view>

      <!-- æ¥è¿‘æœ«å°¾è§£é”æç¤ºï¼ˆäº‘ç«¯ä¹¦ç±ï¼‰ -->
      <view wx:if="{{!isLoading && chapterContent && isCloud && needUnlock && parseRecord}}" class="unlock-hint">
        <text class="unlock-icon">ğŸ”’</text>
        <text class="unlock-text">å³å°†çœ‹å®Œå·²è§£æç« èŠ‚ï¼ˆ{{parseRecord.lastParsedChapter}}/{{parseRecord.totalChapters}}ï¼‰</text>
        <view class="unlock-btn" bindtap="continueParsingChapters">
          <text>ç«‹å³è§£é”åç»­ 30 ç« </text>
        </view>
      </view>

      <!-- æœ€åä¸€ç« æç¤º -->
      <view wx:if="{{!isLoading && chapterContent && currentChapterIndex >= totalChapters - 1 && (!parseRecord || parseRecord.completed)}}" class="end-hint">
        <text>ğŸ‰ å…¨ä¹¦å®Œ</text>
      </view>
    </view>
  </scroll-view>

  <!-- åº•éƒ¨èœå• -->
  <view class="bottom-menu {{showMenu ? 'show' : ''}}">
    <!-- æœªè§£æå®Œæˆæç¤ºï¼ˆä»…äº‘ç«¯ä¹¦ç±ä¸”æ¥è¿‘æœ«å°¾ï¼‰ -->
    <view class="incomplete-parse-hint" wx:if="{{isCloud && needUnlock && parseRecord}}">
      <view class="hint-text">
        <text class="icon">ï¿½</text>
        <text>å·²è§£æ {{parseRecord.lastParsedChapter}}/{{parseRecord.totalChapters}} ç« </text>
      </view>
      <view class="continue-parse-btn" bindtap="continueParsingChapters">
        <text>è§£é”å 50 ç« </text>
      </view>
    </view>

    <!-- é˜…è¯»è¿›åº¦ -->
    <view class="progress-section">
      <text class="progress-text">ç¬¬ {{currentChapterIndex + 1}} / {{totalChapters}} ç« </text>
      <view class="progress-bar">
        <view class="progress-fill" style="width: {{(currentChapterIndex + 1) / totalChapters * 100}}%"></view>
      </view>
    </view>

    <!-- ä¹¦ç­¾åˆ—è¡¨ -->
    <view class="bookmarks-section" wx:if="{{bookmarks.length > 0}}">
      <text class="section-title">ğŸ“– ä¹¦ç­¾</text>
      <scroll-view class="bookmarks-list" scroll-x="{{true}}">
        <view 
          wx:for="{{bookmarks}}" 
          wx:key="createTime"
          class="bookmark-item"
          bindtap="jumpToBookmark"
          data-index="{{index}}"
        >
          <text class="bookmark-title">{{item.chapterTitle}}</text>
          <text class="bookmark-note" wx:if="{{item.note}}">{{item.note}}</text>
          <view class="bookmark-delete" bindtap="deleteBookmark" data-index="{{index}}">
            <text>âœ•</text>
          </view>
        </view>
      </scroll-view>
    </view>

    <!-- åŠŸèƒ½æŒ‰é’® -->
    <view class="menu-actions">
      <view class="action-item" bindtap="showChapterList">
        <text class="action-icon">ğŸ“‘</text>
        <text class="action-label">ç›®å½•</text>
      </view>
      <view class="action-item" bindtap="addBookmark">
        <text class="action-icon">ğŸ“–</text>
        <text class="action-label">ä¹¦ç­¾</text>
      </view>
      <view class="action-item" bindtap="decreaseFontSize">
        <text class="action-icon">A-</text>
        <text class="action-label">ç¼©å°</text>
      </view>
      <view class="action-item" bindtap="increaseFontSize">
        <text class="action-icon">A+</text>
        <text class="action-label">æ”¾å¤§</text>
      </view>
      <view class="action-item" bindtap="toggleNightMode">
        <text class="action-icon">{{themeClass === 'theme-night' ? 'â˜€ï¸' : 'ğŸŒ™'}}</text>
        <text class="action-label">{{themeClass === 'theme-night' ? 'æ—¥é—´' : 'å¤œé—´'}}</text>
      </view>
    </view>
  </view>

  <!-- ç« èŠ‚åˆ—è¡¨æŠ½å±‰ -->
  <view class="drawer-mask {{showChapterDrawer ? 'show' : ''}}" bindtap="closeChapterList"></view>
  <view class="chapter-drawer {{showChapterDrawer ? 'show' : ''}}">
    <view class="drawer-header">
      <text class="drawer-title">ğŸ“‘ ç« èŠ‚ç›®å½•</text>
      <view class="close-btn" bindtap="closeChapterList">
        <text>âœ•</text>
      </view>
    </view>
    <view class="drawer-count">
      <text>å…± {{totalChapters}} ç« </text>
    </view>
    <scroll-view class="chapter-list" scroll-y="{{true}}" scroll-into-view="chapter-{{currentChapterIndex}}">
      <view class="chapter-list-container">
        <view 
          wx:for="{{chapters}}" 
          wx:key="index"
          id="chapter-{{index}}"
          class="chapter-list-item {{index === currentChapterIndex ? 'active' : ''}}"
          bindtap="selectChapter"
          data-index="{{index}}"
        >
          <text class="chapter-number">{{index + 1}}</text>
          <text class="chapter-name">{{item.title}}</text>
          <text class="chapter-arrow">â€º</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- è·³è½¬é¡µç å¼¹çª—ï¼ˆå·²ç§»é™¤ï¼‰-->

  <!-- ä¹¦ç­¾å¼¹çª— -->
  <view class="bookmark-modal {{showBookmarkModal ? 'show' : ''}}">
    <view class="modal-mask" bindtap="closeBookmarkModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">ğŸ“– æ·»åŠ ä¹¦ç­¾</text>
        <view class="modal-close" bindtap="closeBookmarkModal">âœ•</view>
      </view>
      <view class="modal-body">
        <view class="bookmark-info">
          <text class="bookmark-chapter">{{chapterTitle}}</text>
          <text class="bookmark-position">ç¬¬{{currentChapterIndex + 1}}ç« </text>
        </view>
        <textarea 
          class="bookmark-input"
          value="{{bookmarkNote}}"
          placeholder="æ·»åŠ å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰"
          bindinput="onBookmarkInput"
          maxlength="200"
        />
      </view>
      <view class="modal-footer">
        <view class="modal-btn cancel" bindtap="closeBookmarkModal">å–æ¶ˆ</view>
        <view class="modal-btn confirm" bindtap="saveBookmark">ä¿å­˜ä¹¦ç­¾</view>
      </view>
    </view>
  </view>
</view>
