# 紧急修复：数据库权限配置

## 当前问题
即使代码已修改正确，仍然报错：
```
errCode: -502003 database permission denied
```

## 根本原因
`reading_progress` 集合的权限设置可能存在问题，导致客户端无法创建新文档。

---

## 🔥 快速修复方案（临时测试用）

### 步骤 1：修改数据库权限为「所有用户可读写」

1. **打开云开发控制台**
   - 进入微信开发者工具
   - 点击「云开发」按钮
   - 选择「数据库」标签

2. **找到 `reading_progress` 集合**
   - 在左侧集合列表中找到 `reading_progress`
   - 点击集合名称

3. **修改权限设置**
   - 点击「权限设置」标签页
   - 选择权限模板：**「所有用户可读写」**
   - 点击「保存」

**权限配置（JSON）**：
```json
{
  "read": true,
  "write": true
}
```

### 步骤 2：测试功能
1. 重新编译小程序
2. 打开一本云端小说
3. 阅读几章后切换章节（触发保存）
4. 查看控制台是否还有权限错误
5. 关闭小说重新打开，验证进度恢复

---

## ✅ 正式方案（推荐用于生产环境）

### 步骤 1：使用「仅创建者可读写」权限

1. **打开云开发控制台 → 数据库 → reading_progress**
2. **选择权限模板**：**「仅创建者可读写」**
3. **点击保存**

**权限配置（JSON）**：
```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

### 步骤 2：清除旧的测试数据（重要！）

**为什么要清除**：旧数据可能包含手动设置的 `_openid` 字段，导致权限检查失败。

1. 进入「数据库」→「reading_progress」
2. 勾选所有测试记录
3. 点击「删除」按钮

### 步骤 3：重新测试
1. 确保已清除旧数据
2. 重新编译小程序
3. 打开云端小说，阅读并切换章节
4. 检查云数据库是否自动创建了新记录（包含 `_openid` 字段）
5. 关闭小说重新打开，验证进度恢复

---

## 🔍 问题排查步骤

### 如果「仅创建者可读写」仍然报错

#### 检查点 1：确认数据库权限设置
```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

#### 检查点 2：确认代码中没有 `_openid` 赋值
```javascript
// ❌ 错误：不要这样做
const data = {
  _openid: openid,  // ← 删除这行
  novelId: 123
};

// ✅ 正确：让云数据库自动添加
const data = {
  novelId: 123
};
```

#### 检查点 3：查看云函数日志
1. 云开发控制台 → 云函数
2. 选择 `login` 云函数
3. 查看最近的调用记录
4. 确认是否返回了有效的 `openid`

#### 检查点 4：确认小程序云开发初始化
在 `app.js` 中检查：
```javascript
wx.cloud.init({
  env: 'your-env-id',  // 确认环境 ID 正确
  traceUser: true
});
```

---

## 📊 权限模式对比

| 权限模式 | 适用场景 | 安全性 | 性能 |
|---------|---------|--------|------|
| **所有用户可读写** | 开发测试 | ⚠️ 低 | ⭐⭐⭐ 最快 |
| **仅创建者可读写** | 生产环境 | ✅ 高 | ⭐⭐ 正常 |
| **仅管理端可读写** | 敏感数据 | ✅✅ 最高 | ⭐ 需云函数 |

---

## 🚀 验证成功的标志

### 保存进度成功
- ✅ 控制台输出：`阅读进度已保存`
- ✅ 无权限错误 `-502003`
- ✅ 云数据库中有新记录

### 加载进度成功
- ✅ 重新打开小说时定位到上次阅读位置
- ✅ 控制台无 `加载阅读进度失败` 错误

### 数据库记录正确
```json
{
  "_id": "auto-generated-id",
  "_openid": "user-openid-auto-set",  // ← 自动生成
  "novelId": "book-123",
  "chapterIndex": 10,
  "chapterTitle": "第十章 标题",
  "scrollTop": 500,
  "updateTime": 1700654321000
}
```

---

## 💡 推荐做法

### 开发阶段
1. 使用「所有用户可读写」快速验证功能
2. 重点关注业务逻辑是否正确

### 上线前
1. 切换到「仅创建者可读写」
2. 清除所有测试数据
3. 完整测试一遍流程
4. 确认跨设备同步正常

---

## 📝 常见问题 FAQ

### Q1: 为什么删除 `_openid` 后还是报错？
**A**: 可能是数据库中有旧数据，权限检查失败。解决方法：删除 `reading_progress` 集合中的所有测试数据。

### Q2: 如何确认 `_openid` 是否自动生成？
**A**: 在云开发控制台 → 数据库 → `reading_progress` 中查看新创建的记录，应该包含 `_openid` 字段。

### Q3: 能否手动在 `where` 中添加 `_openid` 查询？
**A**: 不需要！云数据库会自动过滤只属于当前用户的数据。手动添加反而可能导致问题。

### Q4: 生产环境应该用哪种权限？
**A**: **「仅创建者可读写」** (`doc._openid == auth.openid`)，既安全又符合微信云开发的最佳实践。

---

**修复时间**: 2025-01-22  
**紧急程度**: 🔥 高（影响阅读进度保存）  
**预计修复时间**: 5 分钟
