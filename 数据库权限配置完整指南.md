# ✅ 数据库权限配置正确指南

## 🔍 当前问题诊断

测试结果显示：
- ✅ 可以添加数据（`add` 成功）
- ❌ 不能删除数据（`remove` 失败）

**原因：** 权限可能配置成了 `"write": true`（允许所有人写入），而不是 `"write": "doc._openid == auth.openid"`（只能操作自己的数据）。

---

## ✅ 正确的权限配置

### reading_progress 和 user_shelf 集合

在云开发控制台设置：

#### 方式1：使用预设模板（推荐）

1. 打开云开发控制台 → 数据库
2. 找到 `reading_progress` 集合
3. 点击 "权限设置"
4. 选择 **"仅创建者可读写"**
5. 保存

对 `user_shelf` 重复相同步骤。

#### 方式2：自定义权限规则

如果没有预设模板，手动配置：

```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

**或者使用更详细的配置：**

```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid",
  "create": true,
  "update": "doc._openid == auth.openid",
  "delete": "doc._openid == auth.openid"
}
```

---

## 📊 权限配置对照表

| 集合名称 | 推荐权限模板 | read | write |
|---------|------------|------|-------|
| `novels` | 所有用户可读，仅创建者可写 | `true` | `doc._openid == auth.openid` |
| `reading_progress` | 仅创建者可读写 | `doc._openid == auth.openid` | `doc._openid == auth.openid` |
| `user_shelf` | 仅创建者可读写 | `doc._openid == auth.openid` | `doc._openid == auth.openid` |

---

## 🔧 详细配置步骤（带截图说明）

### 1. 打开云开发控制台

- 点击微信开发者工具顶部 **"云开发"** 按钮
- 或访问：https://console.cloud.tencent.com/tcb

### 2. 进入数据库管理

- 左侧菜单点击 **"数据库"**
- 看到所有集合列表

### 3. 配置 reading_progress

1. 找到 `reading_progress` 集合
2. 点击集合名称旁边的 **"⚙️ 设置"** 或 **"权限设置"**
3. 查看当前权限配置

   **错误配置（导致问题）：**
   ```json
   {
     "read": true,
     "write": true
   }
   ```
   问题：允许所有人读写，但删除操作被拒绝

   **正确配置：**
   ```json
   {
     "read": "doc._openid == auth.openid",
     "write": "doc._openid == auth.openid"
   }
   ```
   或选择模板："仅创建者可读写"

4. 保存配置

### 4. 配置 user_shelf

重复第3步的操作。

### 5. 配置 novels（如果还没配置）

```json
{
  "read": true,
  "write": "doc._openid == auth.openid"
}
```
或选择模板："所有用户可读，仅创建者可写"

---

## ✅ 验证配置是否正确

配置完成后，运行以下测试：

```javascript
// 完整权限测试（增强版 - 显示具体失败步骤）
const testFullPermission = async () => {
  const db = wx.cloud.database()
  
  console.log('=== 测试 reading_progress ===')
  let addRes
  try {
    // 1. 添加
    addRes = await db.collection('reading_progress').add({ 
      data: { test: 1, time: Date.now() } 
    })
    console.log('✅ 步骤1 - 添加成功:', addRes._id)
  } catch (err) {
    console.error('❌ 步骤1 - 添加失败:', err.errMsg)
    return
  }
  
  try {
    // 2. 读取
    const getRes = await db.collection('reading_progress').doc(addRes._id).get()
    console.log('✅ 步骤2 - 读取成功:', getRes.data)
  } catch (err) {
    console.error('❌ 步骤2 - 读取失败:', err.errMsg)
    console.log('   问题：添加成功但无法读取自己刚创建的数据')
    console.log('   原因：read 权限未设置为 "doc._openid == auth.openid"')
    return
  }
  
  try {
    // 3. 更新
    await db.collection('reading_progress').doc(addRes._id).update({ 
      data: { test: 2 } 
    })
    console.log('✅ 步骤3 - 更新成功')
  } catch (err) {
    console.error('❌ 步骤3 - 更新失败:', err.errMsg)
    console.log('   问题：无法更新自己创建的数据')
    console.log('   原因：write 权限只设置了 create，没有 update')
    return
  }
  
  try {
    // 4. 删除
    await db.collection('reading_progress').doc(addRes._id).remove()
    console.log('✅ 步骤4 - 删除成功')
  } catch (err) {
    console.error('❌ 步骤4 - 删除失败:', err.errMsg)
    console.log('   问题：无法删除自己创建的数据')
    console.log('   原因：write 权限只设置了 create，没有 delete')
    return
  }
  
  console.log('🎉🎉🎉 reading_progress 权限配置完全正确！')
  
  console.log('\n=== 测试 user_shelf ===')
  let addRes2
  try {
    addRes2 = await db.collection('user_shelf').add({ 
      data: { test: 1, time: Date.now() } 
    })
    console.log('✅ 步骤1 - 添加成功:', addRes2._id)
  } catch (err) {
    console.error('❌ 步骤1 - 添加失败:', err.errMsg)
    return
  }
  
  try {
    const getRes = await db.collection('user_shelf').doc(addRes2._id).get()
    console.log('✅ 步骤2 - 读取成功')
  } catch (err) {
    console.error('❌ 步骤2 - 读取失败:', err.errMsg)
    console.log('   问题：添加成功但无法读取自己刚创建的数据')
    console.log('   原因：read 权限未设置为 "doc._openid == auth.openid"')
    return
  }
  
  try {
    await db.collection('user_shelf').doc(addRes2._id).update({ 
      data: { test: 2 } 
    })
    console.log('✅ 步骤3 - 更新成功')
  } catch (err) {
    console.error('❌ 步骤3 - 更新失败:', err.errMsg)
    console.log('   问题：无法更新自己创建的数据')
    console.log('   原因：write 权限只设置了 create，没有 update')
    return
  }
  
  try {
    await db.collection('user_shelf').doc(addRes2._id).remove()
    console.log('✅ 步骤4 - 删除成功')
  } catch (err) {
    console.error('❌ 步骤4 - 删除失败:', err.errMsg)
    console.log('   问题：无法删除自己创建的数据')
    console.log('   原因：write 权限只设置了 create，没有 delete')
    return
  }
  
  console.log('🎉🎉🎉 user_shelf 权限配置完全正确！')
}

testFullPermission()
```

**期望看到：**
```
=== 测试 reading_progress ===
✅ 添加成功: xxxxx
✅ 读取成功: { test: 1, ... }
✅ 更新成功
✅ 删除成功
🎉 reading_progress 权限配置正确！

=== 测试 user_shelf ===
✅ 添加成功: xxxxx
✅ 更新成功
✅ 删除成功
🎉 user_shelf 权限配置正确！
```

---

## 🎯 为什么要这样配置？

### 问题场景分析：

#### 场景1：`write: true`（错误）
```
用户A：添加自己的进度 ✅
用户A：删除自己的进度 ❌ 权限不足
用户B：删除用户A的进度 ❌ 权限不足

问题：write: true 只允许创建，不允许修改/删除
```

#### 场景2：`write: "doc._openid == auth.openid"`（正确）
```
用户A：添加自己的进度 ✅
用户A：修改自己的进度 ✅
用户A：删除自己的进度 ✅
用户B：读取用户A的进度 ❌ 权限不足（隐私保护）

好处：完整的CRUD权限，同时保护隐私
```

---

## 💡 权限规则详解

### `doc._openid == auth.openid` 是什么意思？

```javascript
doc._openid      // 数据记录的 _openid 字段（创建者）
auth.openid      // 当前登录用户的 openid
==               // 相等判断

完整意思：
只有当前用户的 openid 等于数据创建者的 openid 时，
才允许进行操作
```

### 云开发自动添加 `_openid`

当使用 `.add()` 添加数据时：
```javascript
await db.collection('reading_progress').add({
  data: {
    novelId: 'xxx',
    currentPage: 10
  }
})

// 云开发自动添加 _openid 字段：
// {
//   novelId: 'xxx',
//   currentPage: 10,
//   _openid: 'oVAxOvr...'  // 自动添加
// }
```

---

## 🚨 常见错误配置

### ❌ 错误1：过于开放
```json
{
  "read": true,
  "write": true
}
```
问题：所有人都能读写，没有隐私保护

### ❌ 错误2：过于严格
```json
{
  "read": false,
  "write": false
}
```
问题：没人能访问，包括数据拥有者

### ❌ 错误3：只读不写
```json
{
  "read": "doc._openid == auth.openid",
  "write": false
}
```
问题：不能保存进度

### ✅ 正确配置
```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```
完美：用户只能访问自己的数据

---

## 📞 配置后的最终测试

1. **重新编译小程序**（Ctrl+B）

2. **打开书籍阅读**
   ```javascript
   wx.navigateTo({ url: '/pages/novel/shelf/shelf' })
   ```
   点击《中场主宰-惊艳一脚》

3. **翻几页**

4. **关闭阅读页面**

5. **重新打开书籍**
   - 应该自动定位到上次位置
   - 不再显示权限错误

6. **查看保存的数据**
   ```javascript
   wx.cloud.database().collection('reading_progress')
     .get()
     .then(res => {
       console.log('我的阅读进度:', res.data)
       res.data.forEach(p => {
         console.log(`📖 ${p.novelTitle}: 第${p.currentPage + 1}页`)
       })
     })
   ```

---

**现在请去云开发控制台，将 `reading_progress` 和 `user_shelf` 的权限改为"仅创建者可读写"！** 🔧

改完后运行完整权限测试，应该全部通过！✅
