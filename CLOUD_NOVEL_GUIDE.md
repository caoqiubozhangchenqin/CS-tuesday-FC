# 云端小说上传功能说明

## 📚 功能概述

现在你可以将自己的小说文件（TXT、EPUB）上传到云存储，并在小程序中阅读！

## ✨ 支持格式

### 1. TXT 格式
- ✅ UTF-8 编码
- ✅ GBK/GB2312 编码（自动检测）
- ✅ 自动识别章节（支持多种格式）
  - `第一章`、`第1章`
  - `第一百二十三章`
  - `Chapter 1`
- ✅ 无章节标记时自动分段

### 2. EPUB 格式
- ✅ 标准 EPUB 2.0/3.0 格式
- ✅ 自动解压和解析
- ✅ 提取章节标题和内容
- ✅ 自动去除HTML标签

## 📱 使用步骤

### 第一步：准备文件
1. 将小说文件放到手机上
2. 确保文件大小不超过 **10MB**
3. 文件名最好包含书名（会自动识别）

### 第二步：上传
1. 打开小程序 → **我的书架**
2. 点击顶部 **📤 上传** 按钮
3. 点击 **选择文件**
4. 从手机选择 TXT 或 EPUB 文件

### 第三步：填写信息
系统会自动填充部分信息：
- **书名**：从文件名提取（可修改）
- **作者**：需要手动输入
- **简介**：可选填
- **分类**：选择合适的分类

### 第四步：上传到云端
1. 点击 **上传到云端** 按钮
2. 等待上传进度完成
3. 上传成功后自动显示在列表中

### 第五步：阅读
1. 在云端书籍列表中点击书籍
2. 点击 **阅读** 按钮
3. 系统会自动解析并加入书架
4. 开始阅读！

## ⚙️ 云函数配置

### 安装依赖

进入云函数目录：
```bash
cd cloudfunctions/parseNovel
npm install
```

### 上传部署

在微信开发者工具中：
1. 右键点击 `parseNovel` 云函数
2. 选择 **上传并部署：云端安装依赖**
3. 等待部署完成

## 🗄️ 数据库配置

### 创建集合

在云开发控制台创建集合：
```
集合名称：novels
权限设置：仅创建者可读写
```

### 数据结构

```javascript
{
  _id: "自动生成",
  _openid: "用户openid",
  name: "书名",
  author: "作者",
  intro: "简介",
  category: "分类",
  format: "TXT/EPUB",
  fileID: "cloud://...",
  cloudPath: "novels/...",
  size: 12345,
  sizeText: "1.23 MB",
  uploadTime: "服务器时间"
}
```

## 📋 EPUB 格式详解

### EPUB 是什么？
EPUB 是电子书的标准格式，本质上是一个 ZIP 压缩包，包含：
- **HTML 文件**：章节内容
- **CSS 文件**：样式
- **图片文件**：封面、插图
- **OPF 文件**：元数据和目录
- **NCX 文件**：导航

### 解析流程
1. 下载 EPUB 文件
2. 解压 ZIP 包
3. 查找并解析 `.opf` 文件
4. 提取章节列表（spine）
5. 按顺序读取 HTML 章节
6. 去除 HTML 标签，提取纯文本
7. 返回章节数组

### 示例 OPF 结构
```xml
<package>
  <manifest>
    <item id="chapter1" href="chapter1.html" />
    <item id="chapter2" href="chapter2.html" />
  </manifest>
  <spine>
    <itemref idref="chapter1" />
    <itemref idref="chapter2" />
  </spine>
</package>
```

## 🔧 高级配置

### 修改文件大小限制

在 `upload.js` 中修改：
```javascript
const maxSize = 20 * 1024 * 1024; // 改为 20MB
```

### 添加更多格式支持

1. 修改文件选择器：
```javascript
extension: ['txt', 'epub', 'pdf', 'mobi']
```

2. 在云函数中添加解析函数：
```javascript
async function parsePDF(fileID) {
  // PDF 解析逻辑
}
```

### 自定义章节分割规则

在云函数 `parseTXT` 中修改正则表达式：
```javascript
const patterns = [
  /第[零〇一二三四五六七八九十百千万0-9]+[章节回]/g,
  /第[0-9]+章/g,
  /Chapter\s*[0-9]+/gi,
  // 添加自定义规则
  /[0-9]+\./g  // 支持 "1. 标题" 格式
];
```

## ⚠️ 常见问题

### 1. 上传失败
**原因**：
- 文件过大（超过10MB）
- 网络连接问题
- 云存储空间不足

**解决**：
- 压缩文件或分卷上传
- 检查网络连接
- 清理云存储空间

### 2. EPUB 解析失败
**原因**：
- EPUB 格式不标准
- 加密的 EPUB
- 损坏的文件

**解决**：
- 使用 Calibre 等工具修复
- 移除 DRM 保护
- 重新下载文件

### 3. 章节识别错误
**原因**：
- TXT 没有明确的章节标记
- 格式不规范

**解决**：
- 手动添加章节标记（如"第一章"）
- 使用规范的章节格式
- 在云函数中添加自定义识别规则

### 4. 乱码问题
**原因**：
- 编码格式不支持

**解决**：
- 云函数已自动处理 UTF-8 和 GBK
- 如需支持其他编码，在云函数中添加：
```javascript
const iconv = require('iconv-lite');
content = iconv.decode(buffer, 'big5'); // Big5编码
```

## 📊 存储限制

### 免费版
- 云存储：2GB
- 数据库：2GB
- 云函数调用：10万次/月

### 建议
- 定期清理不用的书籍
- 压缩大文件
- 合理使用云函数

## 💡 最佳实践

### 1. 文件命名
```
推荐：斗破苍穹-天蚕土豆.txt
不推荐：新建文本文档.txt
```

### 2. TXT 格式
```
第一章 少年萧炎

    "斗之力，三段！"
    
    望着测验魔石碑上面闪亮得甚至有些刺眼的五个大字...
    
第二章 退婚

    ...
```

### 3. 批量上传
可以多次上传，所有书籍都保存在云端列表中。

## 🔒 隐私说明

- 上传的文件仅自己可见（基于 openid 隔离）
- 不会分享给其他用户
- 可随时删除
- 云函数仅用于解析，不存储文件内容

## 🚀 未来计划

- [ ] 支持 PDF 格式
- [ ] 支持 MOBI 格式
- [ ] 批量上传
- [ ] 封面图片提取
- [ ] 书籍分享功能
- [ ] 云端进度同步

---

**更新时间**：2025-11-21  
**版本**：v1.0  
**状态**：✅ 已实现
