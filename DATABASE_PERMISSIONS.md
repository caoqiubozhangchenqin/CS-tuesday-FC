# æ•°æ®åº“æƒé™é…ç½®æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›å°è¯´å°ç¨‹åºæ‰€æœ‰æ•°æ®åº“é›†åˆçš„æƒé™é…ç½®æ–¹æ¡ˆã€‚æ–°æ–¹æ¡ˆå°†**é˜…è¯»è¿›åº¦ç‹¬ç«‹ä¸ºå•ç‹¬çš„é›†åˆ**,è§£å†³æƒé™ç®¡ç†æ··ä¹±çš„é—®é¢˜ã€‚

---

## ğŸ¯ é›†åˆæƒé™é…ç½®æ¸…å•

### 1. novels (å°è¯´ä¿¡æ¯é›†åˆ)

**ä½œç”¨**: å­˜å‚¨æ‰€æœ‰å°è¯´çš„å…ƒæ•°æ®(ä¹¦åã€ä½œè€…ã€ç®€ä»‹ç­‰)

**æƒé™é…ç½®**:
```json
{
  "read": true,
  "write": "doc._openid == auth.openid"
}
```

**è¯´æ˜**:
- âœ… **æ‰€æœ‰äººå¯è¯»**: ç”¨æˆ·å¯ä»¥æµè§ˆæ‰€æœ‰ä¹¦ç±
- âœ… **ä»…ä½œè€…å¯å†™**: åªèƒ½ä¿®æ”¹/åˆ é™¤è‡ªå·±ä¸Šä¼ çš„ä¹¦ç±
- âš ï¸ ç®¡ç†å‘˜æ‰‹åŠ¨æ·»åŠ çš„ä¹¦ç±éœ€è¦æ·»åŠ  `_openid` å­—æ®µ

**æ•°æ®ç»“æ„**:
```javascript
{
  _id: "book001",
  _openid: "ç”¨æˆ·openid",
  name: "ä¸‰ä½“",
  author: "åˆ˜æ…ˆæ¬£",
  intro: "ç§‘å¹»å°è¯´",
  category: "ç§‘å¹»",
  format: "TXT",
  fileID: "cloud://...",
  cloudPath: "å°è¯´/ä¸‰ä½“.txt",
  size: 1234567,
  sizeText: "1.2 MB",
  uploadTime: 1732257854000,
  createTime: Date
}
```

---

### 2. novel_chapters (ç« èŠ‚å†…å®¹é›†åˆ)

**ä½œç”¨**: å­˜å‚¨æ‰€æœ‰å°è¯´çš„ç« èŠ‚å†…å®¹

**æƒé™é…ç½®**:
```json
{
  "read": true,
  "write": "doc._openid == auth.openid"
}
```

**è¯´æ˜**:
- âœ… **æ‰€æœ‰äººå¯è¯»**: ç”¨æˆ·å¯ä»¥é˜…è¯»æ‰€æœ‰ç« èŠ‚
- âœ… **ä»…ä½œè€…å¯å†™**: åªèƒ½ä¿®æ”¹/åˆ é™¤è‡ªå·±ä¹¦ç±çš„ç« èŠ‚
- â„¹ï¸ ç« èŠ‚é€šè¿‡ `novelId` å…³è”åˆ°å°è¯´

**æ•°æ®ç»“æ„**:
```javascript
{
  _id: "chapter001",
  _openid: "ç”¨æˆ·openid",
  novelId: "book001",
  chapterId: 0,
  title: "ç¬¬ä¸€ç« ",
  content: "ç« èŠ‚å†…å®¹...",
  link: "chapter_0",
  createTime: Date
}
```

---

### 3. reading_progress (é˜…è¯»è¿›åº¦é›†åˆ) ğŸ†•

**ä½œç”¨**: å­˜å‚¨ç”¨æˆ·çš„é˜…è¯»è¿›åº¦(ç‹¬ç«‹é›†åˆ,ç®€åŒ–æƒé™ç®¡ç†)

**æƒé™é…ç½®**:
```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

**è¯´æ˜**:
- âœ… **ä»…æœ¬äººå¯è¯»**: ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„é˜…è¯»è¿›åº¦
- âœ… **ä»…æœ¬äººå¯å†™**: ç”¨æˆ·åªèƒ½ä¿®æ”¹è‡ªå·±çš„é˜…è¯»è¿›åº¦
- ğŸ¯ **å®Œç¾è§£å†³æƒé™é—®é¢˜**: ä¸éœ€è¦å¤æ‚çš„åµŒå¥—æƒé™

**æ•°æ®ç»“æ„**:
```javascript
{
  _id: "progress001",
  _openid: "ç”¨æˆ·openid",
  novelId: "book001",
  chapterIndex: 5,
  chapterTitle: "ç¬¬äº”ç« ",
  scrollTop: 1234,
  updateTime: 1732257854000
}
```

**ç´¢å¼•å»ºè®®**:
- `_openid` + `novelId` (è”åˆç´¢å¼•,åŠ é€ŸæŸ¥è¯¢)

---

### 4. users (ç”¨æˆ·ä¿¡æ¯é›†åˆ)

**ä½œç”¨**: å­˜å‚¨ç”¨æˆ·åŸºæœ¬ä¿¡æ¯(æ˜µç§°ã€å¤´åƒã€èº«ä»·ç­‰)

**æƒé™é…ç½®**:
```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

**è¯´æ˜**:
- âœ… **ä»…æœ¬äººå¯è¯»**: ä¿æŠ¤ç”¨æˆ·éšç§
- âœ… **ä»…æœ¬äººå¯å†™**: ç”¨æˆ·åªèƒ½ä¿®æ”¹è‡ªå·±çš„ä¿¡æ¯
- â„¹ï¸ ä¸å†å­˜å‚¨é˜…è¯»è¿›åº¦(å·²è¿ç§»åˆ° reading_progress é›†åˆ)

**æ•°æ®ç»“æ„**:
```javascript
{
  _id: "user001",
  _openid: "ç”¨æˆ·openid",
  nickname: "å¼ ä¸‰",
  avatarUrl: "https://...",
  userValue: 100,
  selectedTeam: "team001",
  // å…¶ä»–ç”¨æˆ·ä¿¡æ¯...
  createTime: Date
}
```

---

## ğŸš€ é…ç½®æ­¥éª¤

### ç¬¬ä¸€æ­¥: åˆ›å»º reading_progress é›†åˆ

1. æ‰“å¼€äº‘å¼€å‘æ§åˆ¶å°
2. æ•°æ®åº“ â†’ ç‚¹å‡» **+ æ·»åŠ é›†åˆ**
3. é›†åˆåç§°: `reading_progress`
4. æƒé™è®¾ç½®:
   ```json
   {
     "read": "doc._openid == auth.openid",
     "write": "doc._openid == auth.openid"
   }
   ```
5. ç‚¹å‡»**ç¡®å®š**

### ç¬¬äºŒæ­¥: ä¿®æ”¹ novels é›†åˆæƒé™

1. æ•°æ®åº“ â†’ `novels` é›†åˆ â†’ æƒé™è®¾ç½®
2. æ”¹ä¸º:
   ```json
   {
     "read": true,
     "write": "doc._openid == auth.openid"
   }
   ```
3. ä¿å­˜

### ç¬¬ä¸‰æ­¥: ä¿®æ”¹ novel_chapters é›†åˆæƒé™

1. æ•°æ®åº“ â†’ `novel_chapters` é›†åˆ â†’ æƒé™è®¾ç½®
2. æ”¹ä¸º:
   ```json
   {
     "read": true,
     "write": "doc._openid == auth.openid"
   }
   ```
3. ä¿å­˜

### ç¬¬å››æ­¥: ä¿®æ”¹ users é›†åˆæƒé™

1. æ•°æ®åº“ â†’ `users` é›†åˆ â†’ æƒé™è®¾ç½®
2. æ”¹ä¸º:
   ```json
   {
     "read": "doc._openid == auth.openid",
     "write": "doc._openid == auth.openid"
   }
   ```
3. ä¿å­˜

---

## âš ï¸ è¿ç§»æ³¨æ„äº‹é¡¹

### æ—§æ•°æ®è¿ç§»

å¦‚æœä¹‹å‰åœ¨ `users` é›†åˆä¸­å­˜å‚¨äº†é˜…è¯»è¿›åº¦,å¯ä»¥é€‰æ‹©:

**æ–¹æ¡ˆ1: è‡ªç„¶è¿‡æ¸¡**
- æ–°è¿›åº¦ä¿å­˜åˆ° `reading_progress` é›†åˆ
- æ—§è¿›åº¦é€æ¸è¢«æ–°è¿›åº¦è¦†ç›–
- æ— éœ€æ‰‹åŠ¨è¿ç§»

**æ–¹æ¡ˆ2: ä¸€æ¬¡æ€§è¿ç§»(å¯é€‰)**
åœ¨äº‘å¼€å‘æ§åˆ¶å°æ‰§è¡Œä»¥ä¸‹è„šæœ¬:
```javascript
// æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·
const users = await db.collection('users').get();

for (const user of users.data) {
  if (user.readingProgress) {
    // éå†è¯¥ç”¨æˆ·çš„æ‰€æœ‰é˜…è¯»è¿›åº¦
    for (const [novelId, progress] of Object.entries(user.readingProgress)) {
      // åˆ›å»ºæ–°çš„è¿›åº¦è®°å½•
      await db.collection('reading_progress').add({
        data: {
          _openid: user._openid,
          novelId: novelId,
          chapterIndex: progress.chapterIndex,
          chapterTitle: progress.chapterTitle,
          scrollTop: progress.scrollTop,
          updateTime: progress.updateTime
        }
      });
    }
  }
}
```

---

## ğŸ‰ ä¼˜åŠ¿æ€»ç»“

### æ–°æ–¹æ¡ˆä¼˜åŠ¿

âœ… **æƒé™æ¸…æ™°**: æ¯ä¸ªé›†åˆçš„æƒé™èŒè´£æ˜ç¡®
âœ… **æ˜“äºç®¡ç†**: é˜…è¯»è¿›åº¦ç‹¬ç«‹,ä¸å½±å“ç”¨æˆ·ä¿¡æ¯
âœ… **æ€§èƒ½ä¼˜åŒ–**: ç‹¬ç«‹ç´¢å¼•,æŸ¥è¯¢æ›´å¿«
âœ… **æ‰©å±•æ€§å¥½**: æœªæ¥å¯ä»¥è½»æ¾æ·»åŠ æ›´å¤šè¿›åº¦ç›¸å…³åŠŸèƒ½
âœ… **æ•°æ®å®‰å…¨**: ç”¨æˆ·æ•°æ®éš”ç¦»,äº’ä¸å¹²æ‰°

### å¯¹æ¯”æ—§æ–¹æ¡ˆ

| æ–¹é¢ | æ—§æ–¹æ¡ˆ (usersé›†åˆåµŒå¥—) | æ–°æ–¹æ¡ˆ (reading_progressé›†åˆ) |
|------|------------------------|------------------------------|
| æƒé™ç®¡ç† | âŒ å¤æ‚,å®¹æ˜“å‡ºé”™ | âœ… ç®€å•æ¸…æ™° |
| æŸ¥è¯¢æ€§èƒ½ | âš ï¸ éœ€è¦æŸ¥è¯¢æ•´ä¸ªç”¨æˆ·æ–‡æ¡£ | âœ… åªæŸ¥è¯¢è¿›åº¦è®°å½• |
| æ•°æ®ç»“æ„ | âŒ åµŒå¥—å¤æ‚ | âœ… å¹³é“ºç®€å• |
| æ‰©å±•æ€§ | âš ï¸ å—é™äºç”¨æˆ·æ–‡æ¡£å¤§å° | âœ… æ— é™åˆ¶ |
| ç»´æŠ¤æˆæœ¬ | âŒ é«˜ | âœ… ä½ |

---

## ğŸ“ é—®é¢˜æ’æŸ¥

### å¸¸è§é”™è¯¯

**é”™è¯¯: -502003 database permission denied**

**åŸå› **: æƒé™é…ç½®ä¸æ­£ç¡®

**è§£å†³**:
1. æ£€æŸ¥é›†åˆæƒé™æ˜¯å¦æŒ‰æœ¬æ–‡æ¡£é…ç½®
2. ç¡®ä¿ç‚¹å‡»äº†**ä¿å­˜**æŒ‰é’®
3. åˆ·æ–°å°ç¨‹åºé‡è¯•

---

**é”™è¯¯: æ‰¾ä¸åˆ° reading_progress é›†åˆ**

**åŸå› **: é›†åˆæœªåˆ›å»º

**è§£å†³**:
1. æŒ‰ç…§"é…ç½®æ­¥éª¤"ç¬¬ä¸€æ­¥åˆ›å»ºé›†åˆ
2. ç¡®ä¿é›†åˆåç§°æ‹¼å†™æ­£ç¡®

---

## ğŸ“ æ›´æ–°æ—¥å¿—

- **2025-11-22**: åˆ›å»ºç‹¬ç«‹çš„ reading_progress é›†åˆ,ä¼˜åŒ–æƒé™ç®¡ç†
- **2025-11-22**: ä¿®æ”¹ reader.js ä½¿ç”¨æ–°é›†åˆ
- **2025-11-22**: ä¼˜åŒ– upload.js åˆ é™¤åŠŸèƒ½,åŒæ—¶åˆ é™¤ç« èŠ‚

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [äº‘å°è¯´åŠŸèƒ½æŒ‡å—](./CLOUD_NOVEL_GUIDE.md)
- [å°è¯´ç« èŠ‚è¯†åˆ«ä¼˜åŒ–è¯´æ˜](./å°è¯´ç« èŠ‚è¯†åˆ«ä¼˜åŒ–è¯´æ˜.md)
- [ä¹¦æ¶ä¸æ˜¾ç¤ºä¹¦ç±-ä¿®å¤æŒ‡å—](./ä¹¦æ¶ä¸æ˜¾ç¤ºä¹¦ç±-ä¿®å¤æŒ‡å—.md)

---

**å®Œæˆé…ç½®å,æ‰€æœ‰æƒé™é—®é¢˜éƒ½å°†å¾—åˆ°è§£å†³!** ğŸ‰
