# 公共小说系统 - 快速入门

## 🎯 系统特点

✅ **不解析章节** - 避免解析失败和超时问题  
✅ **横向翻页** - 流畅的左右滑动阅读体验  
✅ **公共内容** - 所有用户共享小说库，极大降低存储成本  
✅ **个人进度** - 每个用户独立的阅读进度和书架  
✅ **简单稳定** - 架构简化，维护成本低  

---

## 📁 核心文件结构

```
cloudfunctions/
├── adminUploadNovel/              # 管理员上传小说云函数
│   ├── index.js                   # ⚠️ 需配置管理员 openid
│   ├── package.json
│   └── config.json

miniprogram/pages/novel/
├── bookstore/                     # 📚 书城（展示公共小说）
│   ├── bookstore.js
│   ├── bookstore.wxml
│   └── bookstore.wxss
│
├── reader-v2/                     # 📖 阅读器（横向翻页）
│   ├── reader-v2.js
│   ├── reader-v2.wxml
│   └── reader-v2.wxss
│
└── shelf/                         # 🔖 我的书架（个人收藏）
    └── ...
```

---

## 🗄️ 数据库结构

### novels（公共小说库）
```
权限：所有用户可读，仅云函数可写
字段：title, author, fileID, totalPages, totalChars, ...
```

### reading_progress（阅读进度）
```
权限：仅创建者可读写
字段：novelId, currentPage, charOffset, progress, ...
```

### user_shelf（用户书架）
```
权限：仅创建者可读写
字段：novelId, novelTitle, addTime, lastReadTime, ...
```

---

## 🚀 部署步骤（40分钟）

### 1️⃣ 配置数据库（10分钟）

创建 3 个集合并配置权限：
- `novels` - 权限：`{"read": true, "write": false}`
- `reading_progress` - 权限：`{"read": "doc._openid == auth.openid", "write": "doc._openid == auth.openid"}`
- `user_shelf` - 权限：同上

**详细步骤** → 查看 `数据库集合配置指南.md`

---

### 2️⃣ 部署云函数（5分钟）

1. 获取你的 openid：
```javascript
wx.cloud.callFunction({name: 'login'}).then(res => console.log(res.result.openid))
```

2. 修改 `cloudfunctions/adminUploadNovel/index.js` 第 26 行：
```javascript
const ADMIN_LIST = ['你的openid'];
```

3. 右键 `adminUploadNovel` 文件夹 → 上传并部署

---

### 3️⃣ 上传测试小说（15分钟）

1. 准备一个 TXT 文件（至少 3000 字）
2. 上传到云存储 `novels/` 目录
3. 复制 fileID
4. 调用云函数：

```javascript
wx.cloud.callFunction({
  name: 'adminUploadNovel',
  data: {
    title: '测试小说',
    author: '测试作者',
    category: '古典名著',
    fileID: 'cloud://你的fileID',
    charsPerPage: 500
  }
});
```

---

### 4️⃣ 测试功能（10分钟）

```javascript
// 跳转到书城
wx.navigateTo({url: '/pages/novel/bookstore/bookstore'});
```

测试清单：
- [ ] 书城能看到小说
- [ ] 点击小说进入阅读器
- [ ] 左右滑动翻页流畅
- [ ] 关闭重新打开，进度恢复
- [ ] 书架功能正常

---

## 💡 核心原理

### 分页算法
```javascript
每页 500 字
总页数 = Math.ceil(总字数 / 500)

例如：3000 字的小说 → 6 页
```

### 进度同步
```javascript
记录：
- currentPage: 当前页码
- charOffset: 字符偏移量（currentPage * 500）

跨设备恢复：
根据 charOffset 重新计算页码
```

### 分段缓存
```javascript
每 100 页为一个分段
只加载当前分段（减少内存占用）

例如：
- 第 1-100 页 → 分段 0
- 第 101-200 页 → 分段 1
```

---

## 📊 成本对比

假设 100 个用户，每人阅读 10 本书（每本 10MB）：

| 方案 | 存储成本 | 节省 |
|------|---------|------|
| 旧方案（私有） | 10GB | - |
| 新方案（公共） | 100MB | **99%** ↓ |

---

## 🎨 用户流程

```
用户打开小程序
    ↓
进入书城（所有人看到相同的小说列表）
    ↓
点击小说 → 进入阅读器
    ↓
左右滑动翻页
    ↓
自动保存进度（每翻一页）
    ↓
关闭小说
    ↓
重新打开 → 自动恢复到上次位置
```

---

## 📝 关键注意事项

### ⚠️ 版权问题
- ✅ 使用公版书籍（作者去世 50 年以上）
- ✅ 原创内容
- ❌ 未授权的版权作品

### ⚠️ 管理员权限
- 只有配置在 `ADMIN_LIST` 中的 openid 才能上传小说
- 普通用户无法上传，只能阅读

### ⚠️ 性能优化
- 单个 TXT 文件建议 < 10MB
- 每页 500 字（不建议修改）
- 分段缓存大小：100 页

---

## 🔧 常用操作

### 添加新小说
```javascript
wx.cloud.callFunction({
  name: 'adminUploadNovel',
  data: {
    title: '小说名',
    author: '作者',
    category: '分类',
    fileID: 'cloud://...',
    charsPerPage: 500
  }
});
```

### 设置推荐小说
```javascript
// 在云开发控制台修改 novels 集合
{
  "isRecommended": true  // 会显示在书城推荐区
}
```

### 删除小说
```javascript
// 在云开发控制台 → 数据库 → novels
// 找到对应记录 → 删除
// ⚠️ 会影响所有用户
```

---

## 📚 相关文档

1. **公共小说系统重构方案-横向翻页.md** - 完整技术方案
2. **数据库集合配置指南.md** - 数据库配置详细步骤
3. **公共小说系统部署指南.md** - 详细部署步骤和测试方法
4. **小说系统重构方案-横向翻页.md** - 通用版本（非公共系统）

---

## ❓ 常见问题速查

| 问题 | 解决方法 | 文档位置 |
|------|---------|---------|
| 书城显示"数据库未初始化" | 创建 novels 集合 | 部署指南-第一步 |
| 云函数返回"权限不足" | 配置管理员 openid | 部署指南-第二步 |
| 阅读器打开失败 | 检查 fileID 是否正确 | 部署指南-第三步 |
| 进度保存失败 | 检查 reading_progress 权限 | 数据库配置指南 |
| 翻页卡顿 | 优化 TXT 文件大小 | 技术方案文档 |

---

## 🎉 完成标志

部署完成后，你应该能：
- ✅ 在书城看到小说列表
- ✅ 点击小说进入横向翻页阅读器
- ✅ 流畅地左右滑动翻页
- ✅ 关闭重新打开时自动恢复进度
- ✅ 多个用户可以同时阅读同一本小说

---

## 📞 技术支持

遇到问题？
1. 查看控制台错误日志
2. 检查云开发日志（云函数 → 日志）
3. 参考相关文档
4. 检查数据库权限配置

---

**预计开发周期**：1-2 天  
**难度等级**：⭐⭐⭐（中等）  
**推荐场景**：公版小说平台、企业文档阅读、教育资料库  

---

**祝开发顺利！** 📖✨
