# äº‘å°è¯´å…±äº«åŠŸèƒ½é…ç½®æŒ‡å—

## ğŸ¯ åŠŸèƒ½è¯´æ˜

å®ç°**å°è¯´å†…å®¹å…¨å‘˜å…±äº«ï¼Œé˜…è¯»è¿›åº¦ç‹¬ç«‹ä¿å­˜**çš„åŠŸèƒ½ï¼š
- âœ… æ‰€æœ‰ç”¨æˆ·éƒ½èƒ½è¯»å–ä»»ä½•äººä¸Šä¼ çš„å°è¯´
- âœ… æ¯ä¸ªç”¨æˆ·çš„é˜…è¯»è¿›åº¦ç‹¬ç«‹ä¿å­˜åœ¨`users`é›†åˆ
- âœ… ä¸åŒç”¨æˆ·é˜…è¯»åŒä¸€æœ¬ä¹¦ï¼Œè¿›åº¦äº’ä¸å¹²æ‰°

---

## ğŸ“Š æ–°çš„æ•°æ®ç»“æ„

### 1. `novels` é›†åˆï¼ˆå°è¯´å…ƒæ•°æ®ï¼‰
```javascript
{
  _id: "novel_123",
  _openid: "ä¸Šä¼ è€…çš„openid",
  name: "å›åˆ°æ˜æœå½“ç‹çˆ·",
  author: "æœˆå…³",
  intro: "ç®€ä»‹...",
  category: "å†å²",
  format: "TXT",
  fileID: "cloud://...",
  size: 5242880,
  uploadTime: "2025-11-22"
}
```

**æƒé™è®¾ç½®**ï¼š
```javascript
{
  "read": true,           // âœ… æ‰€æœ‰äººå¯è¯»
  "write": "doc._openid == auth.openid"  // âŒ ä»…åˆ›å»ºè€…å¯å†™
}
```

---

### 2. `novel_chapters` é›†åˆï¼ˆç« èŠ‚å†…å®¹ï¼‰
```javascript
{
  _id: "chapter_001",
  _openid: "ä¸Šä¼ è€…çš„openid",
  novelId: "novel_123",
  chapterId: 0,
  title: "ç¬¬ä¸€ç«  ç©¿è¶Šæ˜æœ",
  content: "ç« èŠ‚æ­£æ–‡å†…å®¹...",
  link: "chapter_0",
  createTime: "2025-11-22"
}
```

**æƒé™è®¾ç½®**ï¼š
```javascript
{
  "read": true,           // âœ… æ‰€æœ‰äººå¯è¯»
  "write": "doc._openid == auth.openid"  // âŒ ä»…åˆ›å»ºè€…å¯å†™
}
```

---

### 3. â­ `users` é›†åˆï¼ˆç”¨æˆ·æ•°æ® + é˜…è¯»è¿›åº¦ï¼‰
```javascript
{
  _id: "user_001",
  _openid: "ç”¨æˆ·çš„openid",
  nickName: "å¼ ä¸‰",
  avatarUrl: "https://...",
  
  // ğŸ¯ é˜…è¯»è¿›åº¦ï¼ˆæ ¸å¿ƒå­—æ®µï¼‰
  readingProgress: {
    "novel_123": {  // å°è¯´IDä½œä¸ºkey
      chapterIndex: 5,        // è¯»åˆ°ç¬¬5ç« 
      chapterTitle: "ç¬¬äº”ç«  æ±Ÿæ¹–æ©æ€¨",
      scrollTop: 1200,        // æ»šåŠ¨ä½ç½®
      updateTime: 1700000000  // æ›´æ–°æ—¶é—´
    },
    "novel_456": {
      chapterIndex: 10,
      chapterTitle: "ç¬¬åç«  å¤§æˆ˜å°†ä¸´",
      scrollTop: 0,
      updateTime: 1700000100
    }
    // ... å¯ä»¥è®°å½•å¤šæœ¬ä¹¦çš„è¿›åº¦
  },
  
  createTime: "2025-11-22"
}
```

**æƒé™è®¾ç½®**ï¼š
```javascript
{
  "read": "doc._openid == auth.openid",   // âœ… åªèƒ½è¯»å–è‡ªå·±çš„æ•°æ®
  "write": "doc._openid == auth.openid"   // âœ… åªèƒ½å†™å…¥è‡ªå·±çš„æ•°æ®
}
```

---

## ğŸ”§ äº‘å¼€å‘æ§åˆ¶å°é…ç½®

### æ­¥éª¤1ï¼šè®¾ç½® `novels` é›†åˆæƒé™

1. è¿›å…¥**äº‘å¼€å‘æ§åˆ¶å°** â†’ **æ•°æ®åº“**
2. é€‰æ‹© `novels` é›†åˆ
3. ç‚¹å‡»**æƒé™è®¾ç½®**
4. ä¿®æ”¹ä¸ºä»¥ä¸‹å†…å®¹ï¼š

```json
{
  "read": true,
  "write": "doc._openid == auth.openid"
}
```

5. ç‚¹å‡»**ä¿å­˜**

---

### æ­¥éª¤2ï¼šè®¾ç½® `novel_chapters` é›†åˆæƒé™

1. é€‰æ‹© `novel_chapters` é›†åˆ
2. ç‚¹å‡»**æƒé™è®¾ç½®**
3. ä¿®æ”¹ä¸ºï¼š

```json
{
  "read": true,
  "write": "doc._openid == auth.openid"
}
```

4. ç‚¹å‡»**ä¿å­˜**

---

### æ­¥éª¤3ï¼šåˆ›å»º `users` é›†åˆå¹¶è®¾ç½®æƒé™

#### å¦‚æœé›†åˆå·²å­˜åœ¨ï¼š
1. é€‰æ‹© `users` é›†åˆ
2. ç‚¹å‡»**æƒé™è®¾ç½®**
3. ä¿®æ”¹ä¸ºï¼š

```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

#### å¦‚æœé›†åˆä¸å­˜åœ¨ï¼š
1. ç‚¹å‡»**æ·»åŠ é›†åˆ**
2. é›†åˆåç§°ï¼š`users`
3. æƒé™è®¾ç½®é€‰æ‹©ï¼š**ä»…åˆ›å»ºè€…å¯è¯»å†™**ï¼ˆè‡ªåŠ¨è®¾ç½®ä¸ºä¸Šè¿°æƒé™ï¼‰
4. ç‚¹å‡»**ç¡®å®š**

---

### æ­¥éª¤4ï¼šåˆ é™¤æ—§çš„ `reading_progress` é›†åˆï¼ˆå¯é€‰ï¼‰

å¦‚æœå·²å­˜åœ¨ `reading_progress` é›†åˆï¼Œå¯ä»¥åˆ é™¤å®ƒï¼ˆå› ä¸ºç°åœ¨ä½¿ç”¨`users`é›†åˆå­˜å‚¨è¿›åº¦ï¼‰ï¼š

1. é€‰æ‹© `reading_progress` é›†åˆ
2. ç‚¹å‡»å³ä¸Šè§’ **...** èœå•
3. é€‰æ‹©**åˆ é™¤é›†åˆ**
4. ç¡®è®¤åˆ é™¤

---

## ğŸ¯ å·¥ä½œæµç¨‹ç¤ºæ„

### åœºæ™¯ï¼šå¤šç”¨æˆ·é˜…è¯»åŒä¸€æœ¬ä¹¦

```
å°è¯´ï¼šã€Šå›åˆ°æ˜æœå½“ç‹çˆ·ã€‹ (novelId: "novel_123")
ä¸Šä¼ è€…ï¼šç”¨æˆ·A

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          novels é›†åˆ                         â”‚
â”‚  âœ… æ‰€æœ‰äººå¯è¯»                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ { novelId: "novel_123",                     â”‚
â”‚   name: "å›åˆ°æ˜æœå½“ç‹çˆ·",                    â”‚
â”‚   _openid: "ç”¨æˆ·A" }                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       novel_chapters é›†åˆ                    â”‚
â”‚  âœ… æ‰€æœ‰äººå¯è¯»                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¬¬1ç« ã€ç¬¬2ç« ã€ç¬¬3ç« ...ç¬¬500ç«                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“          â†“          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·A    â”‚ â”‚  ç”¨æˆ·B    â”‚ â”‚  ç”¨æˆ·C    â”‚
â”‚ è¯»åˆ°ç¬¬5ç«  â”‚ â”‚ è¯»åˆ°ç¬¬10ç« â”‚ â”‚ è¯»åˆ°ç¬¬3ç«  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“          â†“          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            users é›†åˆ                        â”‚
â”‚  âœ… æ¯äººåªèƒ½è¯»å†™è‡ªå·±çš„æ•°æ®                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ { _openid: "ç”¨æˆ·A",                          â”‚
â”‚   readingProgress: {                        â”‚
â”‚     "novel_123": { chapterIndex: 5 }        â”‚
â”‚   }}                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ { _openid: "ç”¨æˆ·B",                          â”‚
â”‚   readingProgress: {                        â”‚
â”‚     "novel_123": { chapterIndex: 10 }       â”‚
â”‚   }}                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ { _openid: "ç”¨æˆ·C",                          â”‚
â”‚   readingProgress: {                        â”‚
â”‚     "novel_123": { chapterIndex: 3 }        â”‚
â”‚   }}                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… ä»£ç å·²ä¿®æ”¹

### ä¿®æ”¹1ï¼šä¿å­˜é˜…è¯»è¿›åº¦åˆ° `users` é›†åˆ
```javascript
// reader.js - saveProgress()
await db.collection('users')
  .doc(userId)
  .update({
    data: {
      [`readingProgress.${novelId}`]: {
        chapterIndex: 5,
        chapterTitle: "ç¬¬äº”ç« ",
        scrollTop: 1200,
        updateTime: Date.now()
      }
    }
  })
```

### ä¿®æ”¹2ï¼šä» `users` é›†åˆè¯»å–é˜…è¯»è¿›åº¦
```javascript
// reader.js - loadProgress()
const userData = await db.collection('users')
  .where({ _openid: openid })
  .get()

const bookProgress = userData.readingProgress[novelId]
```

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. æµ‹è¯•å°è¯´å…±äº«
1. **ç”¨æˆ·A** ä¸Šä¼ ä¸€æœ¬å°è¯´ã€Šä¸‰ä½“ã€‹
2. **ç”¨æˆ·B** æ‰“å¼€å°ç¨‹åº
3. ç”¨æˆ·Båº”è¯¥èƒ½çœ‹åˆ°å¹¶é˜…è¯»ã€Šä¸‰ä½“ã€‹

### 2. æµ‹è¯•è¿›åº¦ç‹¬ç«‹
1. **ç”¨æˆ·A** é˜…è¯»ã€Šä¸‰ä½“ã€‹åˆ°ç¬¬5ç« 
2. **ç”¨æˆ·B** é˜…è¯»ã€Šä¸‰ä½“ã€‹åˆ°ç¬¬10ç« 
3. ç”¨æˆ·Aé‡æ–°æ‰“å¼€ã€Šä¸‰ä½“ã€‹
   - âœ… åº”è¯¥ä»ç¬¬5ç« ç»§ç»­ï¼ˆè€Œéç¬¬10ç« ï¼‰
4. ç”¨æˆ·Bé‡æ–°æ‰“å¼€ã€Šä¸‰ä½“ã€‹
   - âœ… åº”è¯¥ä»ç¬¬10ç« ç»§ç»­ï¼ˆè€Œéç¬¬5ç« ï¼‰

### 3. éªŒè¯æ•°æ®åº“
åœ¨äº‘å¼€å‘æ§åˆ¶å°æŸ¥çœ‹ï¼š
- `novels` é›†åˆï¼šæœ‰ã€Šä¸‰ä½“ã€‹çš„è®°å½•
- `novel_chapters` é›†åˆï¼šæœ‰ã€Šä¸‰ä½“ã€‹çš„æ‰€æœ‰ç« èŠ‚
- `users` é›†åˆï¼š
  ```javascript
  // ç”¨æˆ·Açš„è®°å½•
  {
    _openid: "ç”¨æˆ·Açš„openid",
    readingProgress: {
      "novel_123": { chapterIndex: 5, ... }
    }
  }
  
  // ç”¨æˆ·Bçš„è®°å½•
  {
    _openid: "ç”¨æˆ·Bçš„openid",
    readingProgress: {
      "novel_123": { chapterIndex: 10, ... }
    }
  }
  ```

---

## ğŸ”’ å®‰å…¨è¯´æ˜

### âœ… å®‰å…¨çš„è®¾è®¡
1. **å°è¯´å†…å®¹**ï¼šæ‰€æœ‰äººå¯è¯»ï¼Œä½†åªæœ‰ä¸Šä¼ è€…å¯ä»¥ä¿®æ”¹/åˆ é™¤
2. **é˜…è¯»è¿›åº¦**ï¼šæ¯ä¸ªç”¨æˆ·åªèƒ½è¯»å†™è‡ªå·±çš„è¿›åº¦æ•°æ®
3. **ç”¨æˆ·éšç§**ï¼šæ— æ³•æŸ¥çœ‹å…¶ä»–ç”¨æˆ·çš„é˜…è¯»è¿›åº¦

### âŒ æ³¨æ„äº‹é¡¹
1. **ä¸è¦å…±äº«æ•æ„Ÿå†…å®¹**ï¼šä»»ä½•äººä¸Šä¼ çš„å°è¯´éƒ½æ˜¯å…¬å¼€çš„
2. **ç‰ˆæƒé—®é¢˜**ï¼šç¡®ä¿ä¸Šä¼ çš„å†…å®¹æ²¡æœ‰ç‰ˆæƒçº çº·
3. **å­˜å‚¨é™åˆ¶**ï¼šå…è´¹ç‰ˆ2GBï¼Œéœ€è¦åˆç†æ§åˆ¶ä¸Šä¼ æ•°é‡

---

## ğŸ“Š æ•°æ®è¿ç§»ï¼ˆå¦‚æœéœ€è¦ï¼‰

### ä»æ—§çš„ `reading_progress` è¿ç§»åˆ° `users`

å¦‚æœä¹‹å‰ä½¿ç”¨äº† `reading_progress` é›†åˆï¼Œéœ€è¦è¿ç§»æ•°æ®ï¼š

```javascript
// åœ¨äº‘å‡½æ•°ä¸­æ‰§è¡Œ
const db = cloud.database()

// 1. æŸ¥è¯¢æ‰€æœ‰æ—§è¿›åº¦
const oldProgress = await db.collection('reading_progress').get()

// 2. æŒ‰ç”¨æˆ·åˆ†ç»„å¹¶è¿ç§»
for (let record of oldProgress.data) {
  const { _openid, novelId, chapterIndex, scrollTop } = record
  
  await db.collection('users')
    .where({ _openid })
    .update({
      data: {
        [`readingProgress.${novelId}`]: {
          chapterIndex,
          scrollTop,
          updateTime: Date.now()
        }
      }
    })
}
```

---

## ğŸ’¡ ä¼˜åŠ¿æ€»ç»“

| å¯¹æ¯”é¡¹ | æ—§æ–¹æ¡ˆï¼ˆreading_progressï¼‰ | æ–°æ–¹æ¡ˆï¼ˆusersï¼‰ |
|--------|---------------------------|----------------|
| æŸ¥è¯¢æ¬¡æ•° | æ¯æ¬¡2æ¬¡ï¼ˆæŸ¥è¯¢+æ›´æ–°ï¼‰ | æ¯æ¬¡1æ¬¡ï¼ˆç›´æ¥æ›´æ–°userï¼‰ |
| æ•°æ®ç»“æ„ | åˆ†æ•£åœ¨å¤šæ¡è®°å½• | é›†ä¸­åœ¨ç”¨æˆ·æ–‡æ¡£ |
| æ‰©å±•æ€§ | éœ€è¦æ–°å»ºé›†åˆ | ç›´æ¥åœ¨userä¸­æ·»åŠ å­—æ®µ |
| æ€§èƒ½ | è¾ƒæ…¢ | æ›´å¿« |
| ç»´æŠ¤æˆæœ¬ | è¾ƒé«˜ | è¾ƒä½ |

---

## ğŸš€ éƒ¨ç½²æ¸…å•

- [x] ä¿®æ”¹ `reader.js` çš„ `saveProgress()` æ–¹æ³•
- [x] ä¿®æ”¹ `reader.js` çš„ `loadProgress()` æ–¹æ³•
- [ ] åœ¨äº‘å¼€å‘æ§åˆ¶å°è®¾ç½® `novels` é›†åˆæƒé™ä¸ºå…¨å‘˜å¯è¯»
- [ ] åœ¨äº‘å¼€å‘æ§åˆ¶å°è®¾ç½® `novel_chapters` é›†åˆæƒé™ä¸ºå…¨å‘˜å¯è¯»
- [ ] åˆ›å»º/é…ç½® `users` é›†åˆæƒé™ä¸ºä»…åˆ›å»ºè€…å¯è¯»å†™
- [ ] ï¼ˆå¯é€‰ï¼‰åˆ é™¤æ—§çš„ `reading_progress` é›†åˆ
- [ ] æµ‹è¯•å¤šç”¨æˆ·é˜…è¯»åŠŸèƒ½
- [ ] æµ‹è¯•é˜…è¯»è¿›åº¦ç‹¬ç«‹æ€§

---

**æ›´æ–°æ—¶é—´**ï¼š2025-11-22  
**ç‰ˆæœ¬**ï¼šv3.0 - å…±äº«é˜…è¯»  
**çŠ¶æ€**ï¼šâœ… ä»£ç å·²æ›´æ–°ï¼Œéœ€é…ç½®äº‘å¼€å‘æƒé™
