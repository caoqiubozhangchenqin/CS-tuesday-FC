# 🚀 快速部署指南

## 当前问题

**错误码**: `-504002`  
**错误信息**: `The size of HTTP response body exceeds the upper limit (6MB)`  
**原因**: 云函数返回的章节数据超过6MB限制

---

## ⚡ 快速解决（3步）

### 第一步：创建数据库集合（1分钟）

1. 打开微信开发者工具
2. 点击工具栏「云开发」按钮
3. 左侧菜单 → 「数据库」
4. 点击右上角「+」添加集合
5. 输入名称：`novel_chapters`
6. 点击「确定」
7. 点击集合名称 → 「权限设置」
8. 选择「所有用户可读，仅创建者可写」
9. 保存

✅ **完成标志**: 数据库中出现 `novel_chapters` 集合

---

### 第二步：部署云函数（2分钟）

1. 在微信开发者工具中找到 `cloudfunctions` 文件夹
2. 右键 `parseNovel` 文件夹
3. 选择「上传并部署：云端安装依赖」
4. 等待部署完成（约30-60秒）
5. 看到「上传成功」提示

✅ **完成标志**: 控制台显示「云函数上传成功」

---

### 第三步：测试功能（3分钟）

1. 点击工具栏「编译」按钮重新编译小程序
2. 进入小说列表页面
3. 上传一个测试文件（建议 2-3MB 的 TXT）
4. 点击刚上传的书籍
5. 等待解析完成（首次需要10-20秒）
6. 看到「已解析 XXX 章」提示
7. 进入阅读页面
8. 测试翻页功能

✅ **完成标志**: 可以正常阅读，翻页流畅

---

## 📋 操作检查清单

逐一完成以下步骤：

- [ ] 创建 `novel_chapters` 数据库集合
- [ ] 配置集合权限为「所有用户可读」
- [ ] 部署 `parseNovel` 云函数
- [ ] 重新编译小程序
- [ ] 上传测试文件（2-3MB）
- [ ] 点击阅读，等待解析
- [ ] 验证阅读功能正常
- [ ] 测试翻页（上一章/下一章）
- [ ] 测试章节目录
- [ ] 再次打开同一本书（应该秒开）

全部完成 ✅ = 问题解决！

---

## 🎯 预期效果

### 首次打开书籍
```
1. 点击书籍
2. 提示「首次打开需解析，请稍候...」
3. 等待 10-20 秒（取决于文件大小）
4. 提示「已解析 500 章」
5. 自动跳转到阅读页
6. 可以正常阅读和翻页
```

### 再次打开书籍
```
1. 点击书籍
2. 提示「加载中...」
3. 2-3 秒后进入阅读页（秒开）
4. 直接显示上次阅读位置
5. 翻页流畅无卡顿
```

---

## 🐛 故障排查

### 问题1: 找不到集合

**现象**: 
```
Collection 'novel_chapters' not found
```

**解决**:
1. 确认集合名称拼写正确（区分大小写）
2. 在云开发控制台刷新页面
3. 等待5秒后重试

---

### 问题2: 云函数部署失败

**现象**: 
```
上传失败：网络错误
```

**解决**:
1. 检查网络连接
2. 关闭 VPN
3. 重新右键上传
4. 尝试「上传并部署：不校验域名」

---

### 问题3: 解析超时

**现象**: 
```
errCode: -504003
Invoking task timed out
```

**解决**:
1. 文件大小建议 < 5MB
2. 等待更长时间（最多60秒）
3. 检查云函数日志（云开发控制台 → 云函数 → 日志）

---

### 问题4: 仍然提示超过6MB

**现象**: 
```
errCode: -504002
Response body exceeds 6MB
```

**解决**:
1. 确认云函数已重新部署
2. 确认 parseNovel/index.js 已修改
3. 删除书籍重新上传
4. 检查云函数版本（控制台查看部署时间）

---

## 📊 验证方式

### 验证数据库
```
1. 打开云开发控制台
2. 进入数据库 → novel_chapters
3. 应该看到章节数据
4. 字段包含：novelId, chapterId, title, content
```

### 验证云函数
```
1. 打开云开发控制台
2. 进入云函数 → parseNovel
3. 查看「版本管理」
4. 确认部署时间是最新的
5. 查看「日志」查看执行记录
```

### 验证阅读功能
```
1. 上传测试书籍
2. 首次打开需要解析
3. 看到「已解析 XXX 章」
4. 进入阅读页面正常显示
5. 翻页流畅
6. 退出后再次打开秒开
```

---

## 🎁 额外优化（可选）

### 优化1: 添加数据库索引

```
云开发控制台 
→ 数据库 
→ novel_chapters 
→ 索引管理
→ 添加索引
→ 字段: novelId
→ 排序: 升序
→ 保存
```

**效果**: 查询速度提升 50%

---

### 优化2: 限制文件大小

**文件**: `miniprogram/pages/novel/upload/upload.js`

**修改**:
```javascript
// 限制单个文件最大 5MB
if (file.size > 5 * 1024 * 1024) {
  wx.showToast({
    title: `文件过大（最大5MB）`,
    icon: 'none'
  });
  return;
}
```

**效果**: 避免超大文件解析超时

---

### 优化3: 清理无用章节

定期执行以下云函数清理30天未访问的章节：

```javascript
// 云函数：cleanOldChapters
const cloud = require('wx-server-sdk');
cloud.init();

exports.main = async (event, context) => {
  const db = cloud.database();
  const _ = db.command;
  const thirtyDaysAgo = new Date(Date.now() - 30*24*60*60*1000);
  
  const result = await db.collection('novel_chapters')
    .where({
      createTime: _.lt(thirtyDaysAgo)
    })
    .remove();
  
  return {
    success: true,
    deleted: result.deleted
  };
};
```

**效果**: 节省数据库空间

---

## 📚 相关文档

需要详细了解？查看这些文档：

- **[CLOUD_FUNCTION_ERRORS.md](./CLOUD_FUNCTION_ERRORS.md)** - 错误详解和完整方案
- **[CLOUD_DATABASE_CHAPTERS.md](./CLOUD_DATABASE_CHAPTERS.md)** - 数据库详细配置
- **[DEPLOY_CLOUD_FUNCTIONS.md](./DEPLOY_CLOUD_FUNCTIONS.md)** - 云函数部署详解
- **[FIX_CLOUD_FUNCTION_TIMEOUT.md](./FIX_CLOUD_FUNCTION_TIMEOUT.md)** - 超时问题解决

---

## ✅ 成功标志

完成部署后，您应该能够：

- ✅ 上传任意大小的 TXT/EPUB 文件（无6MB限制）
- ✅ 首次解析后永久保存（无需重复解析）
- ✅ 再次打开秒开（2-3秒）
- ✅ 翻页流畅无卡顿
- ✅ 章节目录正常显示
- ✅ 阅读进度正常保存
- ✅ 多用户共享同一本书的章节数据

---

## 🆘 需要帮助？

如果遇到问题：

1. **查看云函数日志**
   ```
   云开发控制台 → 云函数 → parseNovel → 日志
   ```

2. **查看数据库数据**
   ```
   云开发控制台 → 数据库 → novel_chapters
   ```

3. **检查小程序控制台**
   ```
   开发者工具 → 调试器 → Console
   ```

4. **查看错误码含义**
   - `-501000`: 云函数不存在 → 需要部署
   - `-504003`: 执行超时 → 增加超时时间
   - `-504002`: 返回超限 → 使用数据库（当前方案）

---

**当前状态**：
- ✅ 代码已修改完成
- ✅ 文档已准备就绪
- ⏳ 等待部署数据库和云函数

**下一步**：
1. 创建 `novel_chapters` 数据库集合
2. 部署 `parseNovel` 云函数
3. 测试上传和阅读功能

按照本指南操作，5分钟内即可完成部署！🚀
