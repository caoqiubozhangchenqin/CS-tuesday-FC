# 修复数据库权限错误 (-502003)

## 问题描述
保存阅读进度时出现错误：
```
errCode: -502003 database permission denied
```

## 根本原因

### 微信云数据库权限机制
当集合的权限设置为：
```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

这意味着：
- ✅ **读取 (read)**：只能读取自己的数据（`_openid` 自动匹配）
- ✅ **更新 (update)**：只能更新自己的数据（已有 `_openid`）
- ❌ **创建 (add)**：**客户端不能显式传入 `_openid` 字段**

### 错误代码示例
```javascript
// ❌ 错误做法：手动设置 _openid
const progressData = {
  _openid: openid,  // ← 这会导致权限错误
  novelId: this.data.bookId,
  chapterIndex: 10
};

await db.collection('reading_progress').add({
  data: progressData
});
```

## 修复方案

### 1. saveProgress() 函数修复
**修改位置**：`miniprogram/pages/novel/reader/reader.js` (约第 659 行)

**修改前**：
```javascript
// 获取 openid
let openid = wx.getStorageSync('userOpenid');
if (!openid) {
  const res = await wx.cloud.callFunction({ name: 'login' });
  openid = res.result.openid;
}

// 准备数据（包含 _openid）
const progressData = {
  _openid: openid,  // ← 移除这行
  novelId: this.data.bookId,
  chapterIndex: this.data.currentChapterIndex,
  scrollTop: this.data.lastScrollTop,
  updateTime: new Date().getTime()
};

// 查询时使用 openid
const existResult = await db.collection('reading_progress')
  .where({
    _openid: openid,  // ← 移除这行
    novelId: this.data.bookId
  })
  .get();
```

**修改后**：
```javascript
// 不需要手动获取 openid

// 准备数据（不包含 _openid）
const progressData = {
  novelId: this.data.bookId,
  chapterIndex: this.data.currentChapterIndex,
  chapterTitle: this.data.chapterTitle,
  scrollTop: this.data.lastScrollTop,
  updateTime: new Date().getTime()
};

// 查询时省略 _openid（云数据库自动过滤）
const existResult = await db.collection('reading_progress')
  .where({
    novelId: this.data.bookId
  })
  .get();

if (existResult.data.length > 0) {
  // 更新现有记录
  await db.collection('reading_progress')
    .doc(existResult.data[0]._id)
    .update({
      data: {
        chapterIndex: progressData.chapterIndex,
        chapterTitle: progressData.chapterTitle,
        scrollTop: progressData.scrollTop,
        updateTime: progressData.updateTime
      }
    });
} else {
  // 创建新记录（_openid 由云数据库自动添加）
  await db.collection('reading_progress')
    .add({
      data: progressData
    });
}
```

### 2. loadProgress() 函数优化
**修改位置**：`miniprogram/pages/novel/reader/reader.js` (约第 720 行)

**修改前**：
```javascript
let openid = wx.getStorageSync('userOpenid');
if (!openid) {
  const res = await wx.cloud.callFunction({ name: 'login' });
  openid = res.result.openid;
}

const result = await db.collection('reading_progress')
  .where({
    _openid: openid,
    novelId: this.data.bookId
  })
  .get();
```

**修改后**：
```javascript
// 云数据库会自动过滤当前用户的 _openid
const result = await db.collection('reading_progress')
  .where({
    novelId: this.data.bookId
  })
  .get();
```

## 核心原理

### 云数据库自动处理 `_openid`
1. **add() 操作**：服务器自动添加 `_openid` 字段（基于当前用户身份）
2. **where() 查询**：自动过滤只属于当前用户的数据
3. **update() 操作**：权限检查通过（因为文档已有 `_openid`）

### 代码简化收益
- ✅ 去掉手动调用 `login` 云函数
- ✅ 去掉 `wx.getStorageSync('userOpenid')`
- ✅ 去掉 `where` 条件中的 `_openid`
- ✅ 去掉 `progressData` 中的 `_openid` 字段
- ✅ 代码更简洁，性能更好

## 测试流程

### 完整测试步骤
1. **清除旧数据**（可选）：
   ```
   云开发控制台 → 数据库 → reading_progress → 删除测试记录
   ```

2. **首次保存进度**：
   - 打开一本云端小说
   - 阅读到第 5 章
   - 切换章节（触发 `saveProgress()`）
   - 检查云数据库是否有新记录（包含自动生成的 `_openid`）

3. **更新进度**：
   - 继续阅读到第 10 章
   - 切换章节
   - 检查云数据库中的记录是否更新为第 10 章

4. **重新进入小说**：
   - 关闭小说页面
   - 重新打开该小说
   - 验证是否从第 10 章开始（触发 `loadProgress()`）

5. **跨设备测试**（如果有条件）：
   - 同一微信号在不同设备登录
   - 验证进度是否同步

## 排查清单

### 如果仍然报错
- [ ] 确认 `reading_progress` 集合权限设置正确
- [ ] 确认代码中没有残留 `_openid: openid` 的赋值
- [ ] 检查网络请求日志（开发者工具 → Network）
- [ ] 查看云函数调用日志（云开发控制台 → 日志）
- [ ] 确认小程序已开启云开发能力

### 数据库权限设置确认
```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

## 修复完成标志
- ✅ 首次保存进度不再报权限错误
- ✅ 云数据库记录包含自动生成的 `_openid` 字段
- ✅ 更新进度正常工作
- ✅ 重新打开小说能正确恢复阅读位置
- ✅ 代码中无手动设置 `_openid` 的地方

## 相关文档
- [微信云数据库权限控制](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/database/security-rules.html)
- [云数据库数据类型](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/reference-sdk-api/database/Database.html)

---
**修复时间**：2025-01-XX  
**影响范围**：阅读进度保存和加载功能  
**部署说明**：修改前端代码后直接上传即可，无需修改云函数或数据库结构
