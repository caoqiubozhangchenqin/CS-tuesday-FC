# ⚠️ 紧急：必须先部署云函数！

## 🔴 您当前的错误

```
errCode: -504003 | Invoking task timed out after 3 seconds
```

**这个错误 100% 是因为：云函数 `adminUploadNovel` 还没有部署到云端！**

---

## ✅ 解决方案（5分钟搞定）

### 📍 第一步：确认云开发环境已开通

1. 点击微信开发者工具顶部的 **"云开发"** 按钮
2. 如果提示"开通云开发"，点击开通
3. 如果已开通，会进入云开发控制台

### 📍 第二步：部署 adminUploadNovel 云函数

#### 方法1：右键上传（推荐，最简单）

1. 在微信开发者工具左侧目录树，找到：
   ```
   cloudfunctions/
     ├── adminUploadNovel/  ← 这个文件夹
     │   ├── config.json
     │   ├── index.js
     │   └── package.json
     ├── calculateStandings/
     ├── cancelJoinTeam/
     └── ...
   ```

2. **右键点击 `adminUploadNovel` 文件夹**

3. 在弹出菜单中选择：
   ```
   📤 上传并部署：云端安装依赖  ← 选这个！
   ```
   **⚠️ 注意：必须选"云端安装依赖"，不要选"不安装依赖"**

4. 等待上传（约30秒-1分钟）
   - 会显示上传进度
   - 看到"上传成功"提示

5. 完成！

#### 方法2：云开发控制台部署

1. 点击顶部"云开发"按钮
2. 点击左侧"云函数"
3. 点击"新建云函数"
4. 名称输入：`adminUploadNovel`
5. 创建后，手动上传代码

---

### 📍 第三步：验证部署成功

在调试器控制台运行这段代码：

```javascript
console.log('🔍 检查云函数是否部署...\n')

wx.cloud.callFunction({
  name: 'adminUploadNovel',
  data: {},
  config: { timeout: 10000 },
  success: res => {
    console.log('✅✅✅ 云函数已成功部署！')
    console.log('返回:', res.result)
    
    if (res.result.code === 'MISSING_PARAMS') {
      console.log('\n🎉 完美！云函数运行正常！')
      console.log('📝 现在可以上传小说了！')
    } else if (res.result.code === 'NO_PERMISSION') {
      console.log('\n⚠️ 权限问题')
      console.log('您的 openid:', res.result.openid)
      console.log('请将此 openid 添加到 adminUploadNovel/index.js 第27行')
    }
  },
  fail: err => {
    console.error('❌❌❌ 云函数未部署或部署失败！')
    console.error('错误:', err.errMsg)
    console.log('\n💡 请重新执行"第二步：部署云函数"')
  }
})
```

**期望看到：**
```
✅✅✅ 云函数已成功部署！
🎉 完美！云函数运行正常！
📝 现在可以上传小说了！
```

**如果看到：**
```
❌❌❌ 云函数未部署或部署失败！
```
→ 说明还没部署成功，重复第二步

---

### 📍 第四步：再次尝试上传

部署成功后：

1. 打开上传页面：
   ```javascript
   wx.navigateTo({ url: '/pages/admin/upload-novel/upload-novel' })
   ```

2. 选择 TXT 文件

3. 点击"开始上传"

4. 成功！🎉

---

## 🔍 常见问题

### Q1: 找不到 adminUploadNovel 文件夹？
**A:** 检查路径：`F:\CSFC\cloudfunctions\adminUploadNovel\`
如果不存在，说明代码文件没有保存成功。

### Q2: 右键菜单没有"上传并部署"选项？
**A:** 
1. 检查是否打开了正确的项目
2. 检查是否登录了微信开发者工具
3. 检查 `project.config.json` 中是否配置了云开发环境

### Q3: 上传后仍然超时？
**A:** 
1. 等待1-2分钟让云函数完全部署
2. 刷新微信开发者工具
3. 重新编译小程序（Ctrl+B）
4. 再次测试

### Q4: 提示"云函数不存在"？
**A:** 在云开发控制台 → 云函数页面，检查是否有 `adminUploadNovel`
- 如果没有：重新上传
- 如果有但是灰色：点击"启用"

---

## 📊 部署状态检查清单

部署成功的标志：

- ✅ 云开发控制台 → 云函数 → 看到 `adminUploadNovel`
- ✅ 状态显示"部署成功"或"运行中"
- ✅ 超时时间显示 60秒（不是3秒）
- ✅ 运行验证脚本返回"云函数已成功部署"

---

## 🎯 快速命令汇总

```javascript
// 1. 验证云函数
wx.cloud.callFunction({
  name: 'adminUploadNovel',
  data: {},
  config: { timeout: 10000 },
  success: res => console.log('✅ 成功:', res.result),
  fail: err => console.error('❌ 失败:', err.errMsg)
})

// 2. 打开上传页面
wx.navigateTo({ url: '/pages/admin/upload-novel/upload-novel' })

// 3. 查看您的 openid
wx.cloud.callFunction({
  name: 'login',
  success: res => console.log('您的openid:', res.result.openid)
})
```

---

**现在请立即执行"第二步：部署云函数"！** 

不部署就无法使用，这是必须的步骤！🚀
