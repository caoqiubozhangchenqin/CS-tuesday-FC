# 🔧 紧急修复：数据库权限错误

## 🚨 当前问题

```
errCode: -502003 database permission denied
```

**原因：** 数据库集合 `reading_progress` 不存在或权限配置错误。

---

## ✅ 立即解决（5分钟）

### 第 1 步：创建 reading_progress 集合

1. **打开云开发控制台**
   - 点击微信开发者工具顶部 "云开发" 按钮
   - 或访问：https://console.cloud.tencent.com/tcb

2. **进入数据库**
   - 点击左侧菜单 "数据库"
   - 点击 "添加集合"

3. **创建集合**
   - 集合名称：`reading_progress`
   - 点击 "确定"

4. **配置权限**
   - 找到刚创建的 `reading_progress` 集合
   - 点击 "权限设置"
   - 选择 **"仅创建者可读写"**
   
   或手动配置为：
   ```json
   {
     "read": "doc._openid == auth.openid",
     "write": "doc._openid == auth.openid"
   }
   ```

---

### 第 2 步：创建其他必要的集合

按照同样的步骤，创建以下集合：

#### ① novels 集合（如果还没有）
- **集合名称**：`novels`
- **权限设置**：所有用户可读，仅创建者可写
  ```json
  {
    "read": true,
    "write": "doc._openid == auth.openid"
  }
  ```

#### ② user_shelf 集合（可选，用于书架功能）
- **集合名称**：`user_shelf`
- **权限设置**：仅创建者可读写
  ```json
  {
    "read": "doc._openid == auth.openid",
    "write": "doc._openid == auth.openid"
  }
  ```

---

### 第 3 步：验证权限配置

在调试器控制台运行：

```javascript
// 测试 reading_progress 权限
wx.cloud.database().collection('reading_progress')
  .add({
    data: {
      novelId: 'test',
      currentPage: 1
    }
  })
  .then(res => {
    console.log('✅ reading_progress 权限正确:', res._id)
    // 清理测试数据
    wx.cloud.database().collection('reading_progress').doc(res._id).remove()
  })
  .catch(err => {
    console.error('❌ reading_progress 权限错误:', err.errMsg)
  })
```

**期望看到：**
```
✅ reading_progress 权限正确: xxxxx
```

---

### 第 4 步：重新打开书籍

1. 关闭阅读页面
2. 重新从书架点击书籍
3. 应该能正常打开并保存进度了

---

## 📊 数据库集合配置总览

| 集合名称 | 权限类型 | 读权限 | 写权限 | 用途 |
|---------|---------|--------|--------|------|
| `novels` | 公共可读 | 所有人 | 仅创建者 | 存储小说元信息 |
| `reading_progress` | 私有 | 仅本人 | 仅本人 | 存储阅读进度 |
| `user_shelf` | 私有 | 仅本人 | 仅本人 | 用户书架（可选） |

---

## 🔍 检查集合是否已创建

在调试器控制台运行：

```javascript
// 检查所有集合
wx.cloud.callFunction({
  name: 'login', // 借用已有云函数获取数据库访问权限
  success: async () => {
    const db = wx.cloud.database()
    
    // 测试各个集合
    const collections = ['novels', 'reading_progress', 'user_shelf']
    
    for (let name of collections) {
      try {
        const res = await db.collection(name).count()
        console.log(`✅ ${name}: 存在，共 ${res.total} 条记录`)
      } catch (err) {
        if (err.errCode === -502005) {
          console.log(`❌ ${name}: 不存在`)
        } else if (err.errCode === -502003) {
          console.log(`⚠️ ${name}: 存在但权限有问题`)
        } else {
          console.log(`❓ ${name}: 未知错误`, err.errMsg)
        }
      }
    }
  }
})
```

---

## 💡 为什么会出现权限错误？

### 数据库权限规则：

1. **公共数据**（如 novels）
   - 所有用户都能读取
   - 只有创建者能修改

2. **私有数据**（如 reading_progress）
   - 只有数据拥有者能访问
   - 通过 `_openid` 字段自动识别

3. **权限配置错误的后果：**
   - `-502003`: 没有权限访问
   - `-502005`: 集合不存在

---

## 🎯 快速配置命令

如果您更喜欢用代码，可以通过云函数初始化集合（可选）：

```javascript
// 创建一个临时云函数 initDatabase
exports.main = async (event, context) => {
  const db = cloud.database()
  
  // 这里只能创建集合，权限需要在控制台手动配置
  await db.createCollection('reading_progress')
  await db.createCollection('user_shelf')
  
  return { success: true }
}
```

但**推荐直接在控制台操作**，更直观更可靠。

---

## ✅ 配置完成后的效果

1. ✅ 打开书籍秒开
2. ✅ 横向翻页流畅
3. ✅ 阅读进度自动保存
4. ✅ 下次打开自动续读
5. ✅ 不会出现权限错误

---

## 📞 仍然有问题？

如果配置后还是报错，请提供：

1. 云开发控制台的集合列表截图
2. `reading_progress` 集合的权限设置截图
3. 控制台的完整错误信息

我会帮您进一步诊断！🔧

---

**现在请立即去云开发控制台创建 `reading_progress` 集合！** 🚀
